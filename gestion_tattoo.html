<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TATTOO - Gestion des T√¢ches (Import Excel)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Styles T√¢ches */
        .card-task { background: white; border-left: 5px solid #0d6efd; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; transition: transform 0.2s; }
        .card-task:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .task-modified { border-left-color: #198754; background-color: #f8fff9; }
        .old-title { text-decoration: line-through; color: #adb5bd; font-size: 0.85em; display: block; margin-bottom: 2px;}
        .new-title { color: #198754; font-weight: 700; font-size: 1.1em; }
        .badge-subtask { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; margin-right: 5px; margin-top: 5px; font-weight: normal; }
        .progress { height: 25px; border-radius: 12px; }
        .avatar-circle { width: 40px; height: 40px; background-color: #e9ecef; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #495057; margin-right: 10px; }

        /* Zone d'import */
        #importScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .drop-zone { border: 3px dashed #cbd5e0; border-radius: 10px; padding: 50px; text-align: center; background-color: #f8f9fa; transition: all 0.3s; cursor: pointer; width: 100%; max-width: 600px; }
        .drop-zone:hover { border-color: #0d6efd; background-color: #e9ecef; }
        .drop-zone.dragover { border-color: #198754; background-color: #d1e7dd; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="importScreen">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">TATTOO Manager</h1>
        <p class="lead text-muted">Gestion et d√©coupage des t√¢ches projet</p>
    </div>

    <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div class="mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="bi bi-file-earmark-spreadsheet text-success" viewBox="0 0 16 16">
                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V9H3V2a1 1 0 0 1 1-1h5.5v2zM3 12v-2h2v2H3zm0 1h2v2H4a1 1 0 0 1-1-1v-1zm3 2v-2h3v2H6zm4 0v-2h3v1a1 1 0 0 1-1 1h-2zm3-3h-3v-2h3v2zm-7 0v-2h3v2H6z"/>
            </svg>
        </div>
        <h4>Glissez votre fichier Excel ici</h4>
        <p class="text-muted">ou cliquez pour s√©lectionner (.xlsx, .xls, .csv)</p>
        <input type="file" id="fileInput" class="d-none" accept=".xlsx, .xls, .csv">
    </div>
    
    <div id="loadingMsg" class="mt-4 hidden">
        <div class="spinner-border text-primary" role="status"></div>
        <span class="ms-2">Lecture du fichier en cours...</span>
    </div>
</div>

<div id="mainApp" class="hidden">
    <nav class="navbar navbar-dark bg-dark sticky-top mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">üõ†Ô∏è TATTOO Manager</span>
            <div class="d-flex gap-2">
                <button onclick="location.reload()" class="btn btn-outline-light btn-sm">üìÇ Changer de fichier</button>
                <button onclick="resetData()" class="btn btn-outline-danger btn-sm">‚ö†Ô∏è Reset</button>
                <button onclick="downloadLogFile()" class="btn btn-success btn-sm">üíæ Sauvegarder (Log)</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tasks-pane">üìã Mes T√¢ches</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#dashboard-pane" onclick="renderDashboard()">üìä Tableau de Bord</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tasks-pane">
                <div class="row mb-4">
                    <div class="col-md-8 offset-md-2">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-white">üë§ Utilisateur</span>
                            <select class="form-select" id="userSelect" onchange="filterTasks()">
                                <option value="">-- S√©lectionnez votre nom --</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="taskListArea" class="row"></div>
            </div>

            <div class="tab-pane fade" id="dashboard-pane">
                <div class="card shadow-sm">
                    <div class="card-body p-0">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">Membre</th><th class="text-center">Total</th><th class="text-center">Modifi√©es</th><th>Progression</th>
                                </tr>
                            </thead>
                            <tbody id="dashboardTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">√âditer la t√¢che</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="currentTaskId">
                <div class="alert alert-light border"><small class="text-muted">Original :</small><br><strong id="modalTaskTitle"></strong></div>
                <ul class="nav nav-pills mb-3"><li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-rename">Renommer</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-split">D√©couper</button></li></ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="pills-rename">
                        <input type="text" class="form-control" id="renameInput">
                        <button onclick="saveRename()" class="btn btn-primary mt-3 w-100">Valider</button>
                    </div>
                    <div class="tab-pane fade" id="pills-split">
                        <div id="subtasksContainer"></div>
                        <button onclick="addSubtaskField()" class="btn btn-sm btn-secondary mt-2">+ Ligne</button>
                        <button onclick="saveSplit()" class="btn btn-primary mt-3 w-100">Valider</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let tasks = [];
    let users = new Set();
    let modifications = [];

    // --- 1. GESTION DU DRAG & DROP ET INPUT FILE ---
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
    });

    dropZone.addEventListener('drop', handleDrop, false);
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files), false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        handleFiles(dt.files);
    }

    function handleFiles(files) {
        if(files.length === 0) return;
        const file = files[0];
        
        document.getElementById('loadingMsg').classList.remove('hidden');
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            try {
                // Utilisation de SheetJS pour lire le fichier
                const workbook = XLSX.read(data, {type: 'array'});
                
                // On prend la premi√®re feuille
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Conversion en tableau de tableaux (header: 1)
                // Cela imite la structure d'un CSV pars√© : [ ['Key', 'Title'...], [1, 'Tache 1'...] ]
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                processData(jsonData);
                
                // Transition UI
                document.getElementById('importScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
            } catch (err) {
                alert("Erreur lors de la lecture du fichier Excel : " + err.message);
                document.getElementById('loadingMsg').classList.add('hidden');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // --- 2. TRAITEMENT DES DONN√âES ---
    function processData(rows) {
        // Charger historique local
        const savedMods = localStorage.getItem('tattoo_mods');
        if (savedMods) modifications = JSON.parse(savedMods);

        tasks = [];
        users = new Set();

        // On suppose que la ligne 0 est le header, on commence √† 1
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            // S√©curit√© : ignorer les lignes vides
            if (!row || row.length < 5) continue; 

            // Mapping bas√© sur les colonnes de votre fichier export√©
            // 0:Key, 5:Title, 7:Status, 9:Priority, 10:Assigned To
            // Note : SheetJS g√®re les types, donc row[0] peut √™tre un nombre, on force en string pour l'ID
            const id = String(row[0] || "");
            const title = row[5] || "Sans titre";
            const status = row[7] || "";
            const priority = row[9] || "";
            const rawUsers = row[10] || "";

            const userList = rawUsers.split(',').map(u => u.trim().split('<')[0].trim()).filter(u => u !== "");
            userList.forEach(u => users.add(u));

            let taskObj = {
                id: id,
                title: title,
                originalTitle: title,
                assignedTo: userList,
                status: status,
                priority: priority,
                isModified: false,
                subTasks: []
            };

            // R√©-appliquer modifs
            const savedState = modifications.find(m => m.taskId === taskObj.id);
            if (savedState) {
                taskObj.isModified = true;
                if (savedState.type === 'rename') taskObj.title = savedState.newValue;
                else if (savedState.type === 'split') taskObj.subTasks = savedState.subTasks;
            }
            tasks.push(taskObj);
        }

        const select = document.getElementById('userSelect');
        select.innerHTML = '<option value="">-- S√©lectionnez votre nom --</option>';
        Array.from(users).sort().forEach(u => {
            if(u) select.innerHTML += `<option value="${u}">${u}</option>`;
        });
    }

    // --- 3. UI LOGIC ---
    function filterTasks() {
        const user = document.getElementById('userSelect').value;
        const area = document.getElementById('taskListArea');
        area.innerHTML = "";
        
        if(!user) return area.innerHTML = `<div class="col-12 text-center text-muted mt-5">S√©lectionnez un utilisateur.</div>`;
        
        const myTasks = tasks.filter(t => t.assignedTo.includes(user));
        if(myTasks.length === 0) return area.innerHTML = `<div class="alert alert-warning">Aucune t√¢che trouv√©e.</div>`;

        myTasks.forEach(t => {
            let content = t.isModified && t.subTasks.length === 0 
                ? `<span class="old-title">${t.originalTitle}</span><span class="new-title">‚ûù ${t.title}</span>`
                : (t.isModified && t.subTasks.length > 0 
                    ? `<span class="old-title mb-2">${t.originalTitle} (D√©coup√©e)</span>` 
                    : `<h5>${t.title}</h5>`);
            
            let subs = t.subTasks.map(s => `<span class="badge badge-subtask">‚Ü≥ ${s}</span>`).join('');

            area.innerHTML += `
            <div class="col-12"><div class="card card-task p-3 ${t.isModified?'task-modified':''}">
                <div class="d-flex justify-content-between">
                    <div class="flex-grow-1">
                        <div class="mb-2"><span class="badge bg-light text-dark border">#${t.id}</span> <span class="badge bg-secondary status-badge">${t.status}</span></div>
                        ${content}
                        <div class="mt-2">${subs}</div>
                    </div>
                    <button class="btn btn-primary btn-sm ms-3" onclick="openModal('${t.id}')">Modifier</button>
                </div>
            </div></div>`;
        });
    }

    // --- 4. MODAL & SAUVEGARDE ---
    const modalEl = new bootstrap.Modal(document.getElementById('actionModal'));
    let currentTask = null;

    function openModal(id) {
        currentTask = tasks.find(t => t.id === id);
        document.getElementById('currentTaskId').value = id;
        document.getElementById('modalTaskTitle').textContent = currentTask.originalTitle;
        document.getElementById('renameInput').value = currentTask.isModified && !currentTask.subTasks.length ? currentTask.title : currentTask.originalTitle;
        const cont = document.getElementById('subtasksContainer');
        cont.innerHTML = "";
        (currentTask.subTasks.length ? currentTask.subTasks : ["",""]).forEach(addSubtaskField);
        modalEl.show();
    }

    function addSubtaskField(val="") {
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `<input type="text" class="form-control sub-input" value="${val}" placeholder="Sous-t√¢che"><button class="btn btn-outline-danger" onclick="this.parentElement.remove()">√ó</button>`;
        document.getElementById('subtasksContainer').appendChild(div);
    }

    function saveRename() {
        const val = document.getElementById('renameInput').value;
        if(!val) return;
        currentTask.title = val; currentTask.subTasks = []; currentTask.isModified = true;
        saveLog('rename', {newValue: val});
        modalEl.hide(); filterTasks();
    }

    function saveSplit() {
        const subs = Array.from(document.querySelectorAll('.sub-input')).map(i => i.value.trim()).filter(v => v);
        if(!subs.length) return alert("Ajoutez au moins une sous-t√¢che");
        currentTask.subTasks = subs; currentTask.isModified = true;
        saveLog('split', {subTasks: subs});
        modalEl.hide(); filterTasks();
    }

    function saveLog(type, data) {
        const user = document.getElementById('userSelect').value;
        modifications = modifications.filter(m => m.taskId !== currentTask.id);
        modifications.push({taskId: currentTask.id, user, date: new Date().toLocaleString(), type, ...data});
        localStorage.setItem('tattoo_mods', JSON.stringify(modifications));
    }

    function resetData() {
        if(confirm("Effacer les modifications locales ?")) { localStorage.removeItem('tattoo_mods'); location.reload(); }
    }

    function downloadLogFile() {
        if(!modifications.length) return alert("Rien √† sauvegarder.");
        let txt = "JOURNAL TATTOO\n================\n";
        modifications.forEach(m => {
            txt += `[${m.date}] ${m.user} | ID:${m.taskId}\n${m.type === 'rename' ? 'Renomm√©: '+m.newValue : 'D√©coup√©:\n - '+m.subTasks.join('\n - ')}\n----------------\n`;
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([txt], {type: 'text/plain'}));
        a.download = `tattoo_log_${Date.now()}.txt`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function renderDashboard() {
        const tbody = document.getElementById('dashboardTableBody');
        tbody.innerHTML = "";
        Array.from(users).sort().forEach(u => {
            if(!u) return;
            const ut = tasks.filter(t => t.assignedTo.includes(u));
            const mod = ut.filter(t => t.isModified).length;
            const pct = ut.length ? Math.round((mod/ut.length)*100) : 0;
            const cls = pct === 100 ? "bg-success" : (pct > 0 ? "bg-info" : "bg-primary");
            tbody.innerHTML += `<tr><td><div class="d-flex align-items-center"><div class="avatar-circle">${u.substring(0,2).toUpperCase()}</div><div>${u}</div></div></td><td class="text-center fw-bold">${ut.length}</td><td class="text-center text-success">${mod}</td><td><div class="progress"><div class="progress-bar ${cls}" style="width:${pct}%">${pct}%</div></div></td></tr>`;
        });
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
