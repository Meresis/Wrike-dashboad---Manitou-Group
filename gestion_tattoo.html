<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TATTOO - Gestion des T√¢ches</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .task-card { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; padding: 15px; transition: all 0.2s; }
        .task-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .task-modified { border-left: 5px solid #198754; background-color: #f0fff4; }
        .old-value { text-decoration: line-through; color: #999; font-size: 0.9em; }
        .new-value { color: #198754; font-weight: bold; }
        .sub-task-badge { background-color: #e9ecef; color: #495057; padding: 2px 6px; border-radius: 4px; font-size: 0.85em; margin-right: 5px; display: inline-block; margin-top: 5px;}
        .progress { height: 25px; }
        .nav-tabs .nav-link.active { font-weight: bold; border-top: 3px solid #0d6efd; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">üõ†Ô∏è TATTOO Project - Task Manager</span>
        <button onclick="downloadLogFile()" class="btn btn-outline-light btn-sm">üíæ T√©l√©charger le Journal (.txt)</button>
    </div>
</nav>

<div class="container">
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks-pane" type="button">üìã Mes T√¢ches</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-pane" type="button" onclick="renderDashboard()">üìä Suivi Global</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <div class="tab-pane fade show active" id="tasks-pane">
            <div class="row mb-4">
                <div class="col-md-6 offset-md-3">
                    <label for="userSelect" class="form-label">üë§ S√©lectionner un utilisateur :</label>
                    <select class="form-select" id="userSelect" onchange="filterTasks()">
                        <option value="">-- Choisir un membre de l'√©quipe --</option>
                    </select>
                </div>
            </div>

            <div id="taskListArea">
                <div class="text-center text-muted mt-5">Veuillez s√©lectionner un utilisateur pour voir ses t√¢ches.</div>
            </div>
        </div>

        <div class="tab-pane fade" id="dashboard-pane">
            <h4 class="mb-3">Avancement par membre de l'√©quipe</h4>
            <div class="card p-3">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Membre</th>
                            <th>Total T√¢ches</th>
                            <th>Trait√©es (Renomm√©es/D√©coup√©es)</th>
                            <th>Progression</th>
                        </tr>
                    </thead>
                    <tbody id="dashboardTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modifier la t√¢che</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="currentTaskId">
                <p><strong>T√¢che actuelle :</strong> <span id="modalTaskTitle"></span></p>
                
                <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-rename" type="button">Renommer</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-split" type="button">D√©couper (Sous-t√¢ches)</button>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="pills-rename">
                        <label class="form-label">Nouveau nom :</label>
                        <input type="text" class="form-control" id="renameInput">
                        <button onclick="saveRename()" class="btn btn-primary mt-3 w-100">Enregistrer le nouveau nom</button>
                    </div>

                    <div class="tab-pane fade" id="pills-split">
                        <label class="form-label">Liste des sous-t√¢ches :</label>
                        <div id="subtasksContainer">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control subtask-input" placeholder="Sous-t√¢che 1">
                            </div>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control subtask-input" placeholder="Sous-t√¢che 2">
                            </div>
                        </div>
                        <button onclick="addSubtaskField()" class="btn btn-sm btn-secondary mb-3">+ Ajouter une ligne</button>
                        <button onclick="saveSplit()" class="btn btn-primary w-100">Valider le d√©coupage</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ---------------------------------------------------------
    // 1. DONN√âES CSV BRUTES (Inject√©es depuis votre fichier)
    // ---------------------------------------------------------
    const rawCsvData = `Key,Folder,Parent task,Default task workflow,Default project workflow,Title,Workflow,Status,Custom status,Priority,Assigned To,Start Date,Duration,Duration (Hours),Effort,Time Spent (Hours),"Budget, ‚Ç¨","Actual Fees, ‚Ç¨","Actual Cost, ‚Ç¨","Planned Fees, ‚Ç¨","Planned Cost, ‚Ç¨",Billing Type,End Date,Depends On,Start Date Constraint,Description,BPO,Budget Type,Budget trend,Commentaires,Compte rendu,Equipe,Gate,Participants,Priorit√© (ne plus utilser),Requester,Risk impact,Risk probability,Risk score,Roadmap Product,Roadmap ann√©e,Sponsor,Type (ne plus utiliser)
1,/,,,,[TATTOO] - GESTION DE PROJET,Default Workflow,Active,On Track,Normal,Romain Doni <r.doni.ext@manitou-group.com>,2025-10-01,373 days,08:00:00,,15:10:00,,,,,,Non-Billable,2027-03-31,,,,,,,,,,,,,,,,,,,,
2,/,,Default Workflow,Default Workflow,/#57002 TATTOO [R&D IS]/,Default Workflow,Active,On Track,,"Alexandre Zemmer <a.zemmer.ext@manitou-group.com>, Xavier Gallard <x.gallard@manitou-group.com>",2025-09-16,,,,,,,,,,Non-Billable,2026-12-31,,,,,,,Attente m√©tier,,"R&D",üå•Ô∏è,,Basse,,3-strong,3-strong,9 - 16 strong,,"2025,2026",,
3,/#57002 TATTOO [R&D IS]/,,,,"#57002 - [TATTOO] Generate the CE certificate, print it and store it in digital for manufactured attachments & batteries",Default Workflow,Active,On Track,Normal,Alexandre Zemmer <a.zemmer.ext@manitou-group.com>,2026-01-19,102 days,00:00:00,,,,,,,,Non-Billable,2026-06-19,,,,,,,,,"R&D",,,,,,,,,,,
4,/#57002 TATTOO [R&D IS]/,"#57002 - [TATTOO] Generate the CE certificate, print it and store it in digital for manufactured attachments & batteries",,,[TATTOO] CE certificate - Workshops,Default Workflow,Active,At Risk,Normal,"Fran√ßois-Joseph Chevre <fj.chevre@manitou-group.com>, Amelie Lelou-Babin <a.leloubabin@manitou-group.com>, Alexandre Zemmer <a.zemmer.ext@manitou-group.com>",2026-01-12,25 days,08:00:00,16:00:00,04:00:00,,,,,,Non-Billable,2026-02-13,"nullFS, nullFS",,"Redmine ticket...",,,,,,,,,,,,,,,,,
5,/#57002 TATTOO [R&D IS]/,"#57002 - [TATTOO] Generate the CE certificate...",,,"[TATTOO] Generate the CE certificate - Conception",Default Workflow,Active,Scheduled,Normal,Alexandre Zemmer <a.zemmer.ext@manitou-group.com>,2026-02-16,10 days,08:00:00,06:00:00,,,,,,,Non-Billable,2026-02-27,4FS,,,,,,,,"R&D",,,,,,,,,,,
6,/#57002 TATTOO [R&D IS]/,"#57002 - [TATTOO] Generate the CE certificate...",,,"[TATTOO] Generate the CE certificate - Development",Default Workflow,Active,Scheduled,Normal,Yannick Laurent <y.laurent@manitou-group.com>,2026-03-02,10 days,08:00:00,08:00:00,,,,,,,Non-Billable,2026-03-13,5FS,,,,,,,,"R&D",,,,,,,,,,,
7,/#57002 TATTOO [R&D IS]/,"#57002 - [TATTOO] Generate the CE certificate...",,,"[TATTOO] Generate the CE certificate - QA",Default Workflow,Active,Scheduled,Normal,Alexandre Zemmer <a.zemmer.ext@manitou-group.com>,2026-03-16,5 days,16:00:00,16:00:00,,,,,,,Non-Billable,2026-03-20,6FS,,,,,,,,"R&D",,,,,,,,,,,
8,/#57002 TATTOO [R&D IS]/,"#57002 - [TATTOO] Generate the CE certificate...",,,"[TATTOO] Generate the CE certificate - UAT",Default Workflow,Active,Scheduled,Normal,Stefano Cremonini <s.cremonini@manitou-group.com>,2026-04-07,1 day,08:00:00,,,,,,,,Non-Billable,2026-04-07,"7FS, nullFS",,,,,,,,"R&D",,,,,,,,,,,
9,/#57002 TATTOO [R&D IS]/,,,,Cadrage - [TATTOO],Default Workflow,Active,On Track,Normal,Alexandre Zemmer <a.zemmer.ext@manitou-group.com>,2025-12-08,68 days,16:00:00,00:00:00,06:00:00,,,,,,Non-Billable,2026-03-27,,,,,,,,,"R&D",,,,,,,,,,,
10,/#57002 TATTOO [R&D IS]/,,,,[TATTOO] Manufacturing - Workshop #1,Default Workflow,Completed,Completed,Normal,"Guillaume Moynard <g.moynard@manitou-group.com>, Alexandre Zemmer <a.zemmer.ext@manitou-group.com>",2025-12-10,1 day,08:00:00,05:00:00,01:00:00,,,,,,Non-Billable,2025-12-10,,,"Compte rendu...",,,,,true,,,,,,,,,,,,
11,/#57002 TATTOO [R&D IS]/,,Default Workflow,Default Workflow,/#57002 TATTOO [R&D IS]/Certificats CE pour les accessoires.../,Intake workflow,Active,Submitted,,Alexandre Zemmer <a.zemmer.ext@manitou-group.com>,2025-11-03,,,,,,,,,,Non-Billable,2026-04-16,,,"Contexte...",,,,,,"R&D",,,,,,,,,,,
13,/#57002 TATTOO [R&D IS]/,,Default Workflow,Default Workflow,/#57002 TATTOO [R&D IS]/Certificats Pi√®ces Accessoires Tattoo/,Default Workflow,Active,New,,Johany Emeriau <jo.emeriau@manitou-group.com>,2025-11-03,,,,,,,,,,Non-Billable,2025-12-19,,,"Responsable m√©tier...",,,,,,"R&D",,,,,,,,,,,
15,/#57002 TATTOO [R&D IS]/RAID Log/,,,,Tattoo Suivi Xavier,Default Workflow,Active,On Track,Normal,Xavier Gallard <x.gallard@manitou-group.com>,2026-02-02,215 days,16:00:00,00:00:00,01:00:00,,,,,,Non-Billable,2026-12-24,,,,,,,,,,,,,,,,,,,,
17,/COMOP/,,,,[TATTOO] WAVE 1 - IT&D COMOP - 13/10,Default Workflow,Completed,Completed,Normal,"Romain Doni <r.doni.ext@manitou-group.com>, Laurent Cholvy <l.cholvy@manitou-group.com>",2025-10-13,1 day,08:00:00,05:00:00,,,,,,,Non-Billable,2025-10-13,,,"CR...",,,,,true,,,,Moyenne,,,,,,,,
26,/RAID Log/,,,,Ressource M3 chez INDUS IT,RAID workflow,Active,To be framed,Normal,Matthieu Avis <m.avis@manitou-group.com>,2025-12-22,2 days,16:00:00,,,,,,,,Non-Billable,2025-12-23,,,"Probl√®me de disponibilit√©...",,,,,,"INDUSTRIAL IT",‚õàÔ∏è,,Critique,,,,,,,,
31,/TATTOO [INDUS IT]/,,,,[TATTOO] - GESTION DE PROJET,Default Workflow,Active,On Track,Normal,Thomas Joubert <t.joubert@manitou-group.com>,2025-10-01,378 days,00:00:00,,,,,,,,Non-Billable,2027-04-26,,,,,,,,,,,,,,,,,,,,
32,/TATTOO [INDUS IT]/,,,,[TATTOO] CJA - Participation R√©union 2026-03-23,Agile Workflow,Active,In Review,Normal,Christian Jacques <c.jacques@manitou-group.com>,2026-03-23,1 day,08:00:00,01:00:00,,,,,,,Non-Billable,2026-03-23,,,,,,,,,,,,,,,,,,,,
46,/TATTOO [INDUS IT]/,,,,[TATTOO] Engraving the plate for manufactured attachments - Development,Default Workflow,Active,Scheduled,Normal,Software Developer,2026-03-23,20 days,16:00:00,08:00:00,,,,,,,Non-Billable,2026-04-20,42FS,,,,,,,,"INDUSTRIAL IT",,,,,,,,,,,
53,/TATTOO [INDUS IT]/,,,,[TATTOO] WAVE 1 - M3 settings MMS001...,Default Workflow,Active,On Track,Normal,Emmanuel Cartier <e.cartier@manitou-group.com>,2025-11-10,31 days,08:00:00,00:00:00,,,,,,,Non-Billable,2025-12-23,nullSS+1w,,,,,,,,"INDUSTRIAL IT",,,,,,,,,,,
70,/TATTOO [P&Q]/,,,,R√©union Settings M3,Default Workflow,Completed,Completed,Normal,Elo√Øse Rivery <e.rivery@manitou-group.com>,2025-11-03,1 day,08:00:00,,,,,,,,Non-Billable,2025-11-03,,,"Minutes...",,,,,,"P&Q",,,Moyenne,,,,,,,,
71,/TATTOO [P&Q]/,,,,TATTOO,Default Workflow,Active,Scheduled,Normal,St√©phane Bechieau <s.bechieau@manitou-group.com>,2026-03-02,209 days,16:00:00,03:00:00,,,,,,,Non-Billable,2026-12-31,,,,,,,,,,,,,,,,,,,,
72,/TATTOO [P&Q]/,,,,TATTOO,Default Workflow,Active,Scheduled,Normal,Florian Poirier <f.poirier@manitou-group.com>,2026-03-02,211 days,08:00:00,03:00:00,,,,,,,Non-Billable,2027-01-05,,,,,,,,,,,,,,,,,,,,
`;
// Note: J'ai tronqu√© les donn√©es pour l'exemple mais le script fonctionnera avec le fichier complet.

    // ---------------------------------------------------------
    // 2. PARSING CSV (Gestion complexe des guillemets)
    // ---------------------------------------------------------
    function parseCSV(text) {
        const rows = [];
        let row = [];
        let currentCell = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];

            if (char === '"') {
                if (inQuotes && nextChar === '"') {
                    currentCell += '"'; // Double quote escaped
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                row.push(currentCell);
                currentCell = '';
            } else if ((char === '\r' || char === '\n') && !inQuotes) {
                if (currentCell || row.length > 0) row.push(currentCell);
                if (row.length > 0) rows.push(row);
                row = [];
                currentCell = '';
                if (char === '\r' && nextChar === '\n') i++; // Skip \n after \r
            } else {
                currentCell += char;
            }
        }
        if (currentCell || row.length > 0) row.push(currentCell);
        if (row.length > 0) rows.push(row);
        return rows;
    }

    // ---------------------------------------------------------
    // 3. LOGIQUE APP
    // ---------------------------------------------------------
    let tasks = [];
    let users = new Set();
    let modifications = []; // Stockage des changements

    function init() {
        const parsedData = parseCSV(rawCsvData);
        // On saute le header (index 0)
        const headers = parsedData[0];
        
        // Mapping simple bas√© sur l'ordre des colonnes du fichier fourni
        // 0:Key, 5:Title, 10:Assigned To, 7:Status
        for (let i = 1; i < parsedData.length; i++) {
            const row = parsedData[i];
            if (row.length < 10) continue; // Ligne vide

            const rawUsers = row[10] || "Unassigned";
            const userList = rawUsers.split(',').map(u => {
                // Nettoyage: "Romain Doni <email>" -> "Romain Doni"
                let clean = u.trim().split('<')[0].trim();
                return clean;
            }).filter(u => u !== "");

            userList.forEach(u => users.add(u));

            tasks.push({
                id: row[0],
                title: row[5],
                originalTitle: row[5],
                assignedTo: userList,
                status: row[7],
                isModified: false,
                subTasks: []
            });
        }

        // Remplir le select
        const select = document.getElementById('userSelect');
        Array.from(users).sort().forEach(user => {
            if(user) {
                const opt = document.createElement('option');
                opt.value = user;
                opt.textContent = user;
                select.appendChild(opt);
            }
        });
    }

    // Afficher les t√¢ches
    function filterTasks() {
        const selectedUser = document.getElementById('userSelect').value;
        const container = document.getElementById('taskListArea');
        container.innerHTML = "";

        if (!selectedUser) {
            container.innerHTML = '<div class="text-center text-muted mt-5">Veuillez s√©lectionner un utilisateur.</div>';
            return;
        }

        const filtered = tasks.filter(t => t.assignedTo.includes(selectedUser));

        if (filtered.length === 0) {
            container.innerHTML = '<div class="alert alert-warning">Aucune t√¢che assign√©e √† cet utilisateur.</div>';
            return;
        }

        filtered.forEach(task => {
            let html = `
                <div class="task-card ${task.isModified ? 'task-modified' : ''}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="badge bg-secondary mb-2">${task.id}</span>
                            <span class="badge bg-info text-dark mb-2">${task.status}</span>
                            <h5>`;
            
            // Affichage Renomm√© ou Normal
            if (task.isModified && task.subTasks.length === 0) {
                html += `<span class="old-value">${task.originalTitle}</span> <br> 
                         <span class="new-value">‚ûù ${task.title}</span>`;
            } else {
                html += `${task.title}`;
            }

            html += `       </h5>`;

            // Affichage Sous-t√¢ches
            if (task.subTasks.length > 0) {
                html += `<div class="mt-2"><strong>Sous-t√¢ches :</strong><br>`;
                task.subTasks.forEach(st => {
                    html += `<span class="sub-task-badge">‚Ü≥ ${st}</span>`;
                });
                html += `</div>`;
            }

            html += `   </div>
                        <button class="btn btn-sm btn-primary" onclick="openModal('${task.id}')">‚öôÔ∏è Modifier</button>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    // Modal
    let currentTask = null;
    const modalEl = new bootstrap.Modal(document.getElementById('actionModal'));

    function openModal(taskId) {
        currentTask = tasks.find(t => t.id === taskId);
        document.getElementById('currentTaskId').value = taskId;
        document.getElementById('modalTaskTitle').textContent = currentTask.title;
        document.getElementById('renameInput').value = currentTask.title;
        
        // Reset inputs
        document.getElementById('subtasksContainer').innerHTML = `
             <div class="input-group mb-2"><input type="text" class="form-control subtask-input" placeholder="Sous-t√¢che 1"></div>
             <div class="input-group mb-2"><input type="text" class="form-control subtask-input" placeholder="Sous-t√¢che 2"></div>
        `;
        
        modalEl.show();
    }

    function addSubtaskField() {
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `<input type="text" class="form-control subtask-input" placeholder="Nouvelle sous-t√¢che">`;
        document.getElementById('subtasksContainer').appendChild(div);
    }

    // Action : Renommer
    function saveRename() {
        const newName = document.getElementById('renameInput').value;
        if (!newName) return;

        currentTask.title = newName;
        currentTask.isModified = true;
        currentTask.subTasks = []; // Reset subtasks if rename is chosen

        logModification(`Renommer: T√¢che ${currentTask.id} renomm√©e en "${newName}"`);
        
        modalEl.hide();
        filterTasks();
    }

    // Action : D√©couper
    function saveSplit() {
        const inputs = document.querySelectorAll('.subtask-input');
        const subs = [];
        inputs.forEach(input => {
            if (input.value.trim() !== "") subs.push(input.value.trim());
        });

        if (subs.length === 0) return alert("Veuillez saisir au moins une sous-t√¢che.");

        currentTask.subTasks = subs;
        currentTask.isModified = true;
        // On garde le titre original pour l'affichage mais on marque modifi√©

        logModification(`D√©coupage: T√¢che ${currentTask.id} d√©coup√©e en : ${subs.join(', ')}`);
        
        modalEl.hide();
        filterTasks();
    }

    // ---------------------------------------------------------
    // 4. SYST√àME DE LOG & SAUVEGARDE
    // ---------------------------------------------------------
    function logModification(details) {
        const now = new Date().toLocaleString('fr-FR');
        const user = document.getElementById('userSelect').value;
        const line = `[${now}] User: ${user} | Action: ${details}`;
        modifications.push(line);
    }

    function downloadLogFile() {
        if (modifications.length === 0) return alert("Aucune modification √† sauvegarder.");

        const content = modifications.join('\n');
        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tattoo_modifications_${new Date().getTime()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // ---------------------------------------------------------
    // 5. DASHBOARD
    // ---------------------------------------------------------
    function renderDashboard() {
        const tbody = document.getElementById('dashboardTableBody');
        tbody.innerHTML = "";

        Array.from(users).sort().forEach(user => {
            if(!user) return;
            
            const userTasks = tasks.filter(t => t.assignedTo.includes(user));
            const total = userTasks.length;
            const modified = userTasks.filter(t => t.isModified).length;
            const percentage = total === 0 ? 0 : Math.round((modified / total) * 100);

            let colorClass = "bg-primary";
            if (percentage === 100) colorClass = "bg-success";
            else if (percentage > 0) colorClass = "bg-warning text-dark";

            const row = `
                <tr>
                    <td>${user}</td>
                    <td>${total}</td>
                    <td>${modified}</td>
                    <td style="width: 40%;">
                        <div class="progress">
                            <div class="progress-bar ${colorClass}" role="progressbar" style="width: ${percentage}%">
                                ${percentage}%
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // Lancement
    window.addEventListener('DOMContentLoaded', init);

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>