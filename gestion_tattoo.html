<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TATTOO - Gestion des T√¢ches</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Cartes de t√¢ches */
        .card-task { 
            background: white; 
            border: none; 
            border-left: 5px solid #0d6efd; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            margin-bottom: 15px; 
            transition: transform 0.2s; 
        }
        .card-task:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .task-modified { border-left-color: #198754; background-color: #f8fff9; }
        .old-title { text-decoration: line-through; color: #adb5bd; font-size: 0.85em; display: block; margin-bottom: 2px;}
        .new-title { color: #198754; font-weight: 700; font-size: 1.1em; }
        
        .badge-subtask { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; margin-right: 5px; margin-top: 5px; font-weight: normal; }
        .status-badge { font-size: 0.8em; padding: 5px 10px; border-radius: 20px; }
        
        /* Dashboard */
        .progress { height: 25px; border-radius: 12px; }
        .avatar-circle { width: 40px; height: 40px; background-color: #e9ecef; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #495057; margin-right: 10px; }

        /* Loader */
        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.95); z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
    <h5>Chargement des donn√©es TATTOO...</h5>
    <p class="text-muted small">R√©cup√©ration depuis GitHub Pages...</p>
</div>

<nav class="navbar navbar-dark bg-dark sticky-top mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1">üõ†Ô∏è TATTOO Manager</span>
        <div class="d-flex gap-2">
            <button onclick="resetData()" class="btn btn-outline-danger btn-sm">‚ö†Ô∏è R√©initialiser tout</button>
            <button onclick="downloadLogFile()" class="btn btn-success btn-sm">üíæ Sauvegarder (Fichier Serveur)</button>
        </div>
    </div>
</nav>

<div class="container">
    
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks-pane" type="button">üìã Mes T√¢ches</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-pane" type="button" onclick="renderDashboard()">üìä Tableau de Bord</button>
        </li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="tasks-pane">
            <div class="row mb-4">
                <div class="col-md-8 offset-md-2">
                    <div class="input-group">
                        <span class="input-group-text bg-white">üë§ Utilisateur</span>
                        <select class="form-select" id="userSelect" onchange="filterTasks()">
                            <option value="">-- Chargement en cours... --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="taskListArea" class="row">
                <div class="col-12 text-center text-muted mt-5">
                    <h4>Bienvenue sur l'outil TATTOO</h4>
                    <p>Veuillez attendre la fin du chargement des donn√©es, puis s√©lectionnez votre nom.</p>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="dashboard-pane">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Suivi de l'avancement global</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Membre de l'√©quipe</th>
                                <th class="text-center">T√¢ches Totales</th>
                                <th class="text-center">Modifi√©es</th>
                                <th>Progression</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">√âditer la t√¢che</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="currentTaskId">
                <div class="alert alert-light border">
                    <small class="text-muted">Titre original :</small><br>
                    <strong id="modalTaskTitle"></strong>
                </div>
                
                <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-rename" type="button">‚úèÔ∏è Renommer</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-split" type="button">‚úÇÔ∏è D√©couper (Sous-t√¢ches)</button>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="pills-rename">
                        <label class="form-label">Nouveau libell√© de la t√¢che :</label>
                        <input type="text" class="form-control" id="renameInput">
                        <div class="d-grid gap-2 mt-3">
                            <button onclick="saveRename()" class="btn btn-primary">Valider le changement de nom</button>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pills-split">
                        <p class="text-muted small">Cr√©ez plusieurs sous-t√¢ches pour remplacer la t√¢che principale.</p>
                        <div id="subtasksContainer"></div>
                        <button onclick="addSubtaskField()" class="btn btn-sm btn-outline-secondary mt-2 mb-3">+ Ajouter une ligne</button>
                        <div class="d-grid gap-2">
                            <button onclick="saveSplit()" class="btn btn-primary">Valider le d√©coupage</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ---------------------------------------------------------
    // CONFIGURATION : URL DU FICHIER DONN√âES
    // ---------------------------------------------------------
    const DATA_URL = "https://meresis.github.io/Wrike-dashboad---Manitou-Group/data_tattoo.txt";

    let tasks = [];
    let users = new Set();
    let modifications = [];

    // ---------------------------------------------------------
    // 1. INITIALISATION & FETCH (CHARGEMENT)
    // ---------------------------------------------------------
    async function init() {
        try {
            // 1. Chargement des sauvegardes locales (Persistance)
            const savedMods = localStorage.getItem('tattoo_mods');
            if (savedMods) {
                modifications = JSON.parse(savedMods);
            }

            // 2. R√©cup√©ration du fichier CSV distant
            // Ajout d'un timestamp pour √©viter le cache du navigateur
            const noCacheUrl = `${DATA_URL}?t=${new Date().getTime()}`;
            
            const response = await fetch(noCacheUrl);
            
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status} - Impossible de lire le fichier.`);
            }

            const rawCsvData = await response.text();
            
            // 3. Traitement des donn√©es
            processData(rawCsvData);
            
            // 4. Masquer le loader
            document.getElementById('loader').style.display = 'none';

        } catch (error) {
            console.error("Erreur critique:", error);
            document.getElementById('loader').innerHTML = `
                <div class="alert alert-danger text-center shadow p-4" style="max-width: 500px;">
                    <h4 class="alert-heading">üö´ Erreur de chargement</h4>
                    <p>Impossible de r√©cup√©rer le fichier de donn√©es √† l'adresse suivante :</p>
                    <code class="d-block mb-3 bg-light p-2 rounded text-break">${DATA_URL}</code>
                    <hr>
                    <p class="mb-0 small">${error.message}</p>
                    <button class="btn btn-outline-danger btn-sm mt-3" onclick="location.reload()">R√©essayer</button>
                </div>
            `;
        }
    }

    // ---------------------------------------------------------
    // 2. PARSING & PROCESSING DES DONN√âES
    // ---------------------------------------------------------
    function processData(csvText) {
        const parsedData = parseCSV(csvText);
        
        // On suppose que la ligne 0 est l'en-t√™te
        for (let i = 1; i < parsedData.length; i++) {
            const row = parsedData[i];
            
            // V√©rification basique pour ignorer les lignes vides
            if (row.length < 5) continue; 

            // Mapping des colonnes bas√© sur l'ordre standard du fichier
            // 0:Key, 5:Title, 7:Status, 9:Priority, 10:Assigned To
            const taskId = row[0];
            const taskTitle = row[5];
            const taskStatus = row[7];
            const taskPriority = row[9];
            const rawUsers = row[10] || "Non assign√©";

            // Nettoyage des utilisateurs (enl√®ve les emails)
            const userList = rawUsers.split(',').map(u => {
                let clean = u.trim().split('<')[0].trim();
                return clean;
            }).filter(u => u !== "");

            userList.forEach(u => users.add(u));

            let taskObj = {
                id: taskId,
                title: taskTitle,
                originalTitle: taskTitle,
                assignedTo: userList,
                status: taskStatus,
                priority: taskPriority,
                isModified: false,
                subTasks: []
            };

            // R√©-appliquer les modifications sauvegard√©es localement
            const savedState = modifications.find(m => m.taskId === taskObj.id);
            if (savedState) {
                taskObj.isModified = true;
                if (savedState.type === 'rename') {
                    taskObj.title = savedState.newValue;
                } else if (savedState.type === 'split') {
                    taskObj.subTasks = savedState.subTasks;
                }
            }

            tasks.push(taskObj);
        }

        // Remplir le selecteur d'utilisateurs
        const select = document.getElementById('userSelect');
        select.innerHTML = '<option value="">-- S√©lectionner votre nom --</option>';
        Array.from(users).sort().forEach(user => {
            if(user) {
                const opt = document.createElement('option');
                opt.value = user;
                opt.textContent = user;
                select.appendChild(opt);
            }
        });
    }

    // Parser CSV robuste (g√®re les guillemets et sauts de ligne dans les cellules)
    function parseCSV(text) {
        const rows = [];
        let row = [];
        let currentCell = '';
        let inQuotes = false;
        
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const nextChar = text[i + 1];

            if (char === '"') {
                if (inQuotes && nextChar === '"') {
                    currentCell += '"'; i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                row.push(currentCell); currentCell = '';
            } else if ((char === '\r' || char === '\n') && !inQuotes) {
                if (currentCell || row.length > 0) row.push(currentCell);
                if (row.length > 0) rows.push(row);
                row = []; currentCell = '';
                if (char === '\r' && nextChar === '\n') i++;
            } else {
                currentCell += char;
            }
        }
        if (currentCell || row.length > 0) row.push(currentCell);
        if (row.length > 0) rows.push(row);
        return rows;
    }

    // ---------------------------------------------------------
    // 3. AFFICHAGE (INTERFACE UTILISATEUR)
    // ---------------------------------------------------------
    function filterTasks() {
        const selectedUser = document.getElementById('userSelect').value;
        const container = document.getElementById('taskListArea');
        container.innerHTML = "";

        if (!selectedUser) {
            container.innerHTML = `<div class="col-12 text-center text-muted mt-5"><h4>Veuillez s√©lectionner un utilisateur.</h4></div>`;
            return;
        }

        const filtered = tasks.filter(t => t.assignedTo.includes(selectedUser));

        if (filtered.length === 0) {
            container.innerHTML = `<div class="alert alert-warning">Aucune t√¢che assign√©e √† ${selectedUser}.</div>`;
            return;
        }

        filtered.forEach(task => {
            let html = `
                <div class="col-12">
                    <div class="card card-task p-3 ${task.isModified ? 'task-modified' : ''}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="mb-2">
                                    <span class="badge bg-light text-dark border">#${task.id}</span>
                                    <span class="badge bg-secondary status-badge">${task.status}</span>
                                    ${task.priority ? `<span class="badge bg-info text-dark status-badge">${task.priority}</span>` : ''}
                                </div>`;
            
            // Logique d'affichage Titre / Sous-t√¢ches
            if (task.isModified && task.subTasks.length === 0) {
                // Cas : Renomm√©
                html += `<span class="old-title">${task.originalTitle}</span>
                         <span class="new-title">‚ûù ${task.title}</span>`;
            } else if (task.isModified && task.subTasks.length > 0) {
                // Cas : D√©coup√©
                html += `<span class="old-title mb-2">${task.originalTitle} (D√©coup√©e)</span>`;
            } else {
                // Cas : Normal
                html += `<h5 class="card-title text-dark">${task.title}</h5>`;
            }

            // Affichage des sous-t√¢ches
            if (task.subTasks.length > 0) {
                html += `<div class="mt-2">`;
                task.subTasks.forEach(st => {
                    html += `<span class="badge badge-subtask">‚Ü≥ ${st}</span>`;
                });
                html += `</div>`;
            }

            html += `       </div>
                            <button class="btn btn-primary btn-sm ms-3" onclick="openModal('${task.id}')">Modifier</button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    // ---------------------------------------------------------
    // 4. GESTION DU MODAL (POPUP D'√âDITION)
    // ---------------------------------------------------------
    let currentTask = null;
    const modalEl = new bootstrap.Modal(document.getElementById('actionModal'));

    function openModal(taskId) {
        currentTask = tasks.find(t => t.id === taskId);
        document.getElementById('currentTaskId').value = taskId;
        document.getElementById('modalTaskTitle').textContent = currentTask.originalTitle;
        
        // Pr√©-remplir le champ renommer
        document.getElementById('renameInput').value = currentTask.isModified && currentTask.subTasks.length === 0 ? currentTask.title : currentTask.originalTitle;
        
        // Pr√©-remplir les sous-t√¢ches
        const container = document.getElementById('subtasksContainer');
        container.innerHTML = "";
        if(currentTask.subTasks.length > 0) {
            currentTask.subTasks.forEach(st => addSubtaskField(st));
        } else {
            addSubtaskField(); // Au moins 2 champs par d√©faut
            addSubtaskField();
        }
        
        modalEl.show();
    }

    function addSubtaskField(val = "") {
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `<input type="text" class="form-control subtask-input" value="${val}" placeholder="Nom de la sous-t√¢che">
                         <button class="btn btn-outline-danger" onclick="this.parentElement.remove()">√ó</button>`;
        document.getElementById('subtasksContainer').appendChild(div);
    }

    function saveRename() {
        const newName = document.getElementById('renameInput').value;
        if (!newName) return;
        
        currentTask.title = newName;
        currentTask.isModified = true;
        currentTask.subTasks = []; // On efface les sous-t√¢ches si on choisit de renommer
        
        saveToLog(currentTask.id, 'rename', { newValue: newName });
        modalEl.hide();
        filterTasks();
    }

    function saveSplit() {
        const inputs = document.querySelectorAll('.subtask-input');
        const subs = [];
        inputs.forEach(input => {
            if (input.value.trim() !== "") subs.push(input.value.trim());
        });
        
        if (subs.length === 0) return alert("Saisissez au moins une sous-t√¢che.");
        
        currentTask.subTasks = subs;
        currentTask.isModified = true;
        
        saveToLog(currentTask.id, 'split', { subTasks: subs });
        modalEl.hide();
        filterTasks();
    }

    // ---------------------------------------------------------
    // 5. SAUVEGARDE ET EXPORT FICHIER TEXTE
    // ---------------------------------------------------------
    function saveToLog(taskId, type, data) {
        const user = document.getElementById('userSelect').value;
        const now = new Date().toLocaleString('fr-FR');
        
        // Mise √† jour de la modification (on √©crase l'ancienne pour la m√™me t√¢che)
        modifications = modifications.filter(m => m.taskId !== taskId);
        
        modifications.push({
            taskId: taskId,
            user: user,
            date: now,
            type: type,
            ...data
        });
        
        // Sauvegarde dans le navigateur
        localStorage.setItem('tattoo_mods', JSON.stringify(modifications));
    }

    function resetData() {
        if(confirm("Voulez-vous effacer toutes les modifications locales ?")) {
            localStorage.removeItem('tattoo_mods');
            location.reload();
        }
    }

    function downloadLogFile() {
        if (modifications.length === 0) return alert("Aucune modification √† sauvegarder.");
        
        let content = "JOURNAL DES MODIFICATIONS TATTOO\n================================\n\n";
        modifications.forEach(m => {
            content += `[${m.date}] Utilisateur: ${m.user}\n`;
            content += `T√¢che ID: ${m.taskId}\n`;
            if (m.type === 'rename') {
                content += `Action: Renommage -> "${m.newValue}"\n`;
            } else {
                content += `Action: D√©coupage -> \n   - ${m.subTasks.join('\n   - ')}\n`;
            }
            content += "--------------------------------\n";
        });

        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tattoo_modifications_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // ---------------------------------------------------------
    // 6. DASHBOARD (TABLEAU DE BORD)
    // ---------------------------------------------------------
    function renderDashboard() {
        const tbody = document.getElementById('dashboardTableBody');
        tbody.innerHTML = "";
        
        Array.from(users).sort().forEach(user => {
            if(!user) return;
            
            const userTasks = tasks.filter(t => t.assignedTo.includes(user));
            const total = userTasks.length;
            const modified = userTasks.filter(t => t.isModified).length;
            const percentage = total === 0 ? 0 : Math.round((modified / total) * 100);
            
            let colorClass = "bg-primary";
            if (percentage === 100) colorClass = "bg-success";
            else if (percentage > 0) colorClass = "bg-info";
            
            // Initiales pour l'avatar
            const initials = user.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();

            const row = `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="avatar-circle">${initials}</div>
                            <div>${user}</div>
                        </div>
                    </td>
                    <td class="text-center fw-bold">${total}</td>
                    <td class="text-center text-success">${modified > 0 ? '+' + modified : '0'}</td>
                    <td style="width: 35%;">
                        <div class="progress">
                            <div class="progress-bar ${colorClass}" role="progressbar" style="width: ${percentage}%">
                                ${percentage}%
                            </div>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // Lancement de l'application
    window.addEventListener('DOMContentLoaded', init);

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
