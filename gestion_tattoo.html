<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TATTOO - Gestion des T√¢ches</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card-task { background: white; border-left: 5px solid #0d6efd; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; transition: transform 0.2s; }
        .card-task:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .task-modified { border-left-color: #198754; background-color: #f8fff9; }
        .old-title { text-decoration: line-through; color: #adb5bd; font-size: 0.85em; display: block; margin-bottom: 2px;}
        .new-title { color: #198754; font-weight: 700; font-size: 1.1em; }
        .badge-subtask { background-color: #e9ecef; color: #495057; border: 1px solid #dee2e6; margin-right: 5px; margin-top: 5px; font-weight: normal; }
        .progress { height: 25px; border-radius: 12px; }
        .avatar-circle { width: 40px; height: 40px; background-color: #e9ecef; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #495057; margin-right: 10px; }

        /* Loader & Overlay */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="loader">
    <div id="spinnerArea">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <h5>Connexion aux donn√©es...</h5>
    </div>
    
    <div id="errorArea" class="hidden">
        <div class="alert alert-warning shadow p-4" style="max-width: 600px;">
            <h4>‚ö†Ô∏è Impossible de charger les donn√©es en ligne</h4>
            <p class="small text-muted">Le navigateur a bloqu√© l'acc√®s automatique ou le lien est incorrect (CORS/404).</p>
            <hr>
            <p class="mb-3">Veuillez s√©lectionner le fichier <strong>data_tattoo.txt</strong> pr√©sent sur votre ordinateur :</p>
            <input type="file" id="fileInput" class="form-control" accept=".txt,.csv">
        </div>
    </div>
</div>

<nav class="navbar navbar-dark bg-dark sticky-top mb-4">
    <div class="container">
        <span class="navbar-brand mb-0 h1">üõ†Ô∏è TATTOO Manager</span>
        <div class="d-flex gap-2">
            <button onclick="document.getElementById('fileInput').click()" class="btn btn-outline-light btn-sm">üìÇ Ouvrir un autre fichier</button>
            <button onclick="resetData()" class="btn btn-outline-danger btn-sm">‚ö†Ô∏è Reset</button>
            <button onclick="downloadLogFile()" class="btn btn-success btn-sm">üíæ Sauvegarder</button>
        </div>
    </div>
</nav>

<div class="container">
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tasks-pane">üìã Mes T√¢ches</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#dashboard-pane" onclick="renderDashboard()">üìä Tableau de Bord</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tasks-pane">
            <div class="row mb-4">
                <div class="col-md-8 offset-md-2">
                    <div class="input-group">
                        <span class="input-group-text bg-white">üë§ Utilisateur</span>
                        <select class="form-select" id="userSelect" onchange="filterTasks()">
                            <option value="">-- En attente de donn√©es --</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="taskListArea" class="row"></div>
        </div>

        <div class="tab-pane fade" id="dashboard-pane">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Membre</th><th class="text-center">Total</th><th class="text-center">Modifi√©es</th><th>Progression</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="actionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">√âditer la t√¢che</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="currentTaskId">
                <div class="alert alert-light border"><small class="text-muted">Original :</small><br><strong id="modalTaskTitle"></strong></div>
                <ul class="nav nav-pills mb-3"><li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pills-rename">Renommer</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pills-split">D√©couper</button></li></ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="pills-rename">
                        <input type="text" class="form-control" id="renameInput">
                        <button onclick="saveRename()" class="btn btn-primary mt-3 w-100">Valider</button>
                    </div>
                    <div class="tab-pane fade" id="pills-split">
                        <div id="subtasksContainer"></div>
                        <button onclick="addSubtaskField()" class="btn btn-sm btn-secondary mt-2">+ Ligne</button>
                        <button onclick="saveSplit()" class="btn btn-primary mt-3 w-100">Valider</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // URL CIBLE
    const DATA_URL = "https://meresis.github.io/Wrike-dashboad---Manitou-Group/data_tattoo.txt";

    let tasks = [];
    let users = new Set();
    let modifications = [];

    // --- 1. CHARGEMENT HYBRIDE (WEB + LOCAL) ---
    async function init() {
        // Charger modifications locales
        const savedMods = localStorage.getItem('tattoo_mods');
        if (savedMods) modifications = JSON.parse(savedMods);

        // Gestionnaire pour le bouton d'upload manuel (Si le web √©choue)
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                processData(e.target.result);
                document.getElementById('loader').classList.add('hidden');
            };
            reader.readAsText(file);
        });

        // Tentative de chargement Web
        try {
            // Timeout de 3 secondes pour ne pas bloquer ind√©finiment
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000);

            const response = await fetch(DATA_URL + "?t=" + Date.now(), { signal: controller.signal });
            clearTimeout(timeoutId);

            if (!response.ok) throw new Error("Erreur HTTP");
            const text = await response.text();
            
            processData(text);
            document.getElementById('loader').classList.add('hidden');

        } catch (error) {
            console.warn("Chargement web √©chou√©, passage en mode manuel.", error);
            // Afficher l'interface de chargement manuel
            document.getElementById('spinnerArea').classList.add('hidden');
            document.getElementById('errorArea').classList.remove('hidden');
        }
    }

    // --- 2. TRAITEMENT DES DONN√âES ---
    function processData(csvText) {
        const parsedData = parseCSV(csvText);
        tasks = [];
        users = new Set();

        for (let i = 1; i < parsedData.length; i++) {
            const row = parsedData[i];
            if (row.length < 5) continue; 

            // Mapping: 0:Key, 5:Title, 7:Status, 9:Priority, 10:Assigned To
            const userList = (row[10] || "").split(',').map(u => u.trim().split('<')[0].trim()).filter(u => u !== "");
            userList.forEach(u => users.add(u));

            let taskObj = {
                id: row[0],
                title: row[5],
                originalTitle: row[5],
                assignedTo: userList,
                status: row[7],
                priority: row[9],
                isModified: false,
                subTasks: []
            };

            // R√©-appliquer modifs
            const savedState = modifications.find(m => m.taskId === taskObj.id);
            if (savedState) {
                taskObj.isModified = true;
                if (savedState.type === 'rename') taskObj.title = savedState.newValue;
                else if (savedState.type === 'split') taskObj.subTasks = savedState.subTasks;
            }
            tasks.push(taskObj);
        }

        const select = document.getElementById('userSelect');
        select.innerHTML = '<option value="">-- S√©lectionner votre nom --</option>';
        Array.from(users).sort().forEach(u => {
            if(u) select.innerHTML += `<option value="${u}">${u}</option>`;
        });
    }

    function parseCSV(text) {
        // Parser robuste
        const rows = []; let row = []; let cell = ''; let quote = false;
        for (let i = 0; i < text.length; i++) {
            let c = text[i], n = text[i+1];
            if (c === '"') { if(quote && n === '"') { cell += '"'; i++; } else { quote = !quote; } }
            else if (c === ',' && !quote) { row.push(cell); cell = ''; }
            else if ((c === '\r' || c === '\n') && !quote) {
                if (cell || row.length) row.push(cell);
                if (row.length) rows.push(row);
                row = []; cell = '';
                if (c === '\r' && n === '\n') i++;
            } else { cell += c; }
        }
        if (cell || row.length) row.push(cell);
        if (row.length) rows.push(row);
        return rows;
    }

    // --- 3. UI LOGIC ---
    function filterTasks() {
        const user = document.getElementById('userSelect').value;
        const area = document.getElementById('taskListArea');
        area.innerHTML = "";
        
        if(!user) return area.innerHTML = `<div class="col-12 text-center text-muted mt-5">S√©lectionnez un utilisateur.</div>`;
        
        const myTasks = tasks.filter(t => t.assignedTo.includes(user));
        if(myTasks.length === 0) return area.innerHTML = `<div class="alert alert-warning">Aucune t√¢che trouv√©e.</div>`;

        myTasks.forEach(t => {
            let content = t.isModified && t.subTasks.length === 0 
                ? `<span class="old-title">${t.originalTitle}</span><span class="new-title">‚ûù ${t.title}</span>`
                : (t.isModified && t.subTasks.length > 0 
                    ? `<span class="old-title mb-2">${t.originalTitle} (D√©coup√©e)</span>` 
                    : `<h5>${t.title}</h5>`);
            
            let subs = t.subTasks.map(s => `<span class="badge badge-subtask">‚Ü≥ ${s}</span>`).join('');

            area.innerHTML += `
            <div class="col-12"><div class="card card-task p-3 ${t.isModified?'task-modified':''}">
                <div class="d-flex justify-content-between">
                    <div class="flex-grow-1">
                        <div class="mb-2"><span class="badge bg-light text-dark border">#${t.id}</span> <span class="badge bg-secondary status-badge">${t.status}</span></div>
                        ${content}
                        <div class="mt-2">${subs}</div>
                    </div>
                    <button class="btn btn-primary btn-sm ms-3" onclick="openModal('${t.id}')">Modifier</button>
                </div>
            </div></div>`;
        });
    }

    // --- 4. MODAL LOGIC ---
    const modalEl = new bootstrap.Modal(document.getElementById('actionModal'));
    let currentTask = null;

    function openModal(id) {
        currentTask = tasks.find(t => t.id === id);
        document.getElementById('currentTaskId').value = id;
        document.getElementById('modalTaskTitle').textContent = currentTask.originalTitle;
        document.getElementById('renameInput').value = currentTask.isModified && !currentTask.subTasks.length ? currentTask.title : currentTask.originalTitle;
        
        const cont = document.getElementById('subtasksContainer');
        cont.innerHTML = "";
        (currentTask.subTasks.length ? currentTask.subTasks : ["",""]).forEach(addSubtaskField);
        modalEl.show();
    }

    function addSubtaskField(val="") {
        const div = document.createElement('div');
        div.className = 'input-group mb-2';
        div.innerHTML = `<input type="text" class="form-control sub-input" value="${val}" placeholder="Sous-t√¢che"><button class="btn btn-outline-danger" onclick="this.parentElement.remove()">√ó</button>`;
        document.getElementById('subtasksContainer').appendChild(div);
    }

    function saveRename() {
        const val = document.getElementById('renameInput').value;
        if(!val) return;
        currentTask.title = val; currentTask.subTasks = []; currentTask.isModified = true;
        saveLog('rename', {newValue: val});
        modalEl.hide(); filterTasks();
    }

    function saveSplit() {
        const subs = Array.from(document.querySelectorAll('.sub-input')).map(i => i.value.trim()).filter(v => v);
        if(!subs.length) return alert("Ajoutez au moins une sous-t√¢che");
        currentTask.subTasks = subs; currentTask.isModified = true;
        saveLog('split', {subTasks: subs});
        modalEl.hide(); filterTasks();
    }

    function saveLog(type, data) {
        const user = document.getElementById('userSelect').value;
        modifications = modifications.filter(m => m.taskId !== currentTask.id);
        modifications.push({taskId: currentTask.id, user, date: new Date().toLocaleString(), type, ...data});
        localStorage.setItem('tattoo_mods', JSON.stringify(modifications));
    }

    function resetData() {
        if(confirm("Effacer tout ?")) { localStorage.removeItem('tattoo_mods'); location.reload(); }
    }

    function downloadLogFile() {
        if(!modifications.length) return alert("Rien √† sauvegarder.");
        let txt = "JOURNAL TATTOO\n================\n";
        modifications.forEach(m => {
            txt += `[${m.date}] ${m.user} | ID:${m.taskId}\n${m.type === 'rename' ? 'Renomm√©: '+m.newValue : 'D√©coup√©:\n - '+m.subTasks.join('\n - ')}\n----------------\n`;
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([txt], {type: 'text/plain'}));
        a.download = `tattoo_log_${Date.now()}.txt`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function renderDashboard() {
        const tbody = document.getElementById('dashboardTableBody');
        tbody.innerHTML = "";
        Array.from(users).sort().forEach(u => {
            if(!u) return;
            const ut = tasks.filter(t => t.assignedTo.includes(u));
            const mod = ut.filter(t => t.isModified).length;
            const pct = ut.length ? Math.round((mod/ut.length)*100) : 0;
            const cls = pct === 100 ? "bg-success" : (pct > 0 ? "bg-info" : "bg-primary");
            tbody.innerHTML += `<tr><td><div class="d-flex align-items-center"><div class="avatar-circle">${u.substring(0,2).toUpperCase()}</div><div>${u}</div></div></td><td class="text-center fw-bold">${ut.length}</td><td class="text-center text-success">${mod}</td><td><div class="progress"><div class="progress-bar ${cls}" style="width:${pct}%">${pct}%</div></div></td></tr>`;
        });
    }

    window.addEventListener('DOMContentLoaded', init);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
