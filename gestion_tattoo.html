<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TATTOO Manager - Gestion & Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        
        /* Ecran Import */
        #importScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .drop-zone { border: 3px dashed #cbd5e0; padding: 40px; border-radius: 10px; background: #f8f9fa; cursor: pointer; text-align: center; transition: 0.3s; }
        .drop-zone:hover { border-color: #0d6efd; background: #e9ecef; }
        
        /* Cartes T√¢ches */
        .card-task { border: none; border-left: 5px solid #6c757d; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; background: white; border-radius: 8px; }
        .card-task.modified { border-left-color: #198754; background-color: #f8fff9; }
        
        /* Boutons Actions */
        .btn-action-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-rename { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .btn-split { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .btn-rename:hover { background-color: #ffe8a1; }
        .btn-split:hover { background-color: #c3e6cb; }

        /* Champs [TATTOO] */
        .input-group-text-prefix { background-color: #e9ecef; color: #495057; font-weight: bold; font-size: 0.85rem; }
        
        /* Admin */
        .admin-zone { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="importScreen">
    <h1 class="mb-4 text-primary fw-bold">TATTOO Manager</h1>
    <div class="drop-zone" onclick="document.getElementById('excelInput').click()">
        <h4 class="mb-3">üìÇ Ouvrir le fichier Excel du projet</h4>
        <p class="text-muted small">Cliquez ou glissez le fichier ici (.xlsx)</p>
        <input type="file" id="excelInput" class="d-none" accept=".xlsx, .xls">
    </div>
</div>

<div id="mainApp" class="hidden">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 px-3">
        <span class="navbar-brand">üõ†Ô∏è TATTOO Manager</span>
        <div class="ms-auto d-flex gap-2">
            <button class="btn btn-outline-light btn-sm" onclick="location.reload()">üîÑ Changer Excel</button>
            <button class="btn btn-success btn-sm fw-bold" onclick="exportUserWork()">üíæ TERMINER (Sauvegarder)</button>
        </div>
    </nav>

    <div class="container">
        <ul class="nav nav-tabs mb-4" id="mainTabs">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#user-panel">üë§ Espace Utilisateur</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#admin-panel" onclick="renderAdminStats()">‚öôÔ∏è Espace Admin</button></li>
        </ul>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="user-panel">
                <div class="row mb-4">
                    <div class="col-md-6 offset-md-3">
                        <select class="form-select form-select-lg shadow-sm" id="userSelect" onchange="renderUserTasks()">
                            <option value="">-- Qui √™tes-vous ? --</option>
                        </select>
                    </div>
                </div>
                <div id="taskListArea"></div>
            </div>

            <div class="tab-pane fade" id="admin-panel">
                <div class="admin-zone mb-4">
                    <h4>üì• Importer les sauvegardes utilisateurs</h4>
                    <p class="text-muted">S√©lectionnez les fichiers textes (.json) envoy√©s par les utilisateurs pour mettre √† jour l'avancement global.</p>
                    <input type="file" id="adminImportInput" class="form-control mb-3" multiple accept=".json,.txt">
                    <div class="alert alert-info py-2 small">
                        Les donn√©es Admin sont stock√©es dans votre navigateur. Vous n'avez pas besoin de r√©importer √† chaque fois, sauf pour mettre √† jour.
                        <button class="btn btn-link p-0 align-baseline" onclick="clearAdminData()">Effacer les donn√©es Admin</button>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-white fw-bold">üìä Avancement Global Consolid√©</div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Collaborateur</th>
                                    <th class="text-center">T√¢ches Excel</th>
                                    <th class="text-center">Trait√©es (Admin DB)</th>
                                    <th>Progression</th>
                                </tr>
                            </thead>
                            <tbody id="adminStatsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning-subtle">
                <h5 class="modal-title">‚úèÔ∏è Renommer la t√¢che</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="renameTaskId">
                <label class="form-label text-muted small">Titre original : <span id="renameOriginalTitle" class="fw-bold"></span></label>
                <div class="input-group">
                    <input type="text" class="form-control fw-bold" id="renameInput">
                </div>
                <div class="form-text text-muted">Le pr√©fixe [TATTOO] est ajout√© par d√©faut.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-100" onclick="confirmRename()">Valider</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="splitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success-subtle">
                <h5 class="modal-title">‚úÇÔ∏è D√©couper en sous-t√¢ches</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="splitTaskId">
                <p class="mb-3">T√¢che m√®re : <strong id="splitOriginalTitle"></strong></p>
                
                <div id="splitInputsContainer">
                    </div>

                <button class="btn btn-outline-success btn-sm mt-2" onclick="addSplitLine()">
                    ‚ûï Ajouter une ligne
                </button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-100" onclick="confirmSplit()">Valider le d√©coupage</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- VARIABLES GLOBALES ---
    let excelTasks = []; // T√¢ches venant de l'Excel (Source de v√©rit√© pour la liste)
    let users = new Set();
    let currentUser = "";
    
    // Donn√©es de travail de l'utilisateur courant
    let userModifications = {}; // Format: { taskId: { type: 'rename'|'split', data: ... } }

    const PREFIX = "[TATTOO] ";

    // --- 1. IMPORT EXCEL ---
    document.getElementById('excelInput').addEventListener('change', handleExcelUpload);

    function handleExcelUpload(e) {
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(evt) {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            processExcelData(jsonData);
            
            document.getElementById('importScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        };
        reader.readAsArrayBuffer(file);
    }

    function processExcelData(rows) {
        excelTasks = [];
        users = new Set();

        // i=1 pour sauter le header
        for(let i=1; i<rows.length; i++) {
            const row = rows[i];
            if(!row || row.length < 5) continue;

            // Mapping colonnes (selon votre CSV pr√©c√©dent)
            // 0:Key, 5:Title, 10:Assigned To
            const id = String(row[0] || "");
            const title = row[5] || "Sans titre";
            const assignedRaw = row[10] || "";

            // Nettoyage users
            const assignedList = assignedRaw.split(',').map(u => u.trim().split('<')[0].trim()).filter(u => u !== "");
            assignedList.forEach(u => users.add(u));

            excelTasks.push({
                id: id,
                originalTitle: title,
                assignedTo: assignedList
            });
        }

        // Remplir Select Utilisateur
        const select = document.getElementById('userSelect');
        select.innerHTML = '<option value="">-- Qui √™tes-vous ? --</option>';
        Array.from(users).sort().forEach(u => {
            select.innerHTML += `<option value="${u}">${u}</option>`;
        });
    }

    // --- 2. GESTION T√ÇCHES UTILISATEUR ---
    function renderUserTasks() {
        currentUser = document.getElementById('userSelect').value;
        const container = document.getElementById('taskListArea');
        container.innerHTML = "";

        if(!currentUser) return;

        // Filtrer les t√¢ches de l'utilisateur
        const myTasks = excelTasks.filter(t => t.assignedTo.includes(currentUser));

        if(myTasks.length === 0) {
            container.innerHTML = `<div class="alert alert-warning text-center">Aucune t√¢che assign√©e.</div>`;
            return;
        }

        myTasks.forEach(task => {
            // V√©rifier si modifi√©e localement dans la session
            const mod = userModifications[task.id];
            const isModified = !!mod;

            let contentHtml = "";
            let badgeHtml = "";

            if(isModified && mod.type === 'rename') {
                contentHtml = `<div class="text-decoration-line-through text-muted small">${task.originalTitle}</div>
                               <div class="fw-bold text-primary">‚ûù ${mod.value}</div>`;
                badgeHtml = `<span class="badge bg-warning text-dark">Renomm√©e</span>`;
            } else if (isModified && mod.type === 'split') {
                contentHtml = `<div class="text-muted small mb-2">${task.originalTitle} (D√©coup√©e)</div>`;
                mod.lines.forEach(line => {
                    contentHtml += `<div class="badge bg-light text-dark border me-1 mb-1">‚Ü≥ ${line}</div>`;
                });
                badgeHtml = `<span class="badge bg-success">D√©coup√©e (${mod.lines.length})</span>`;
            } else {
                contentHtml = `<div class="fw-bold">${task.originalTitle}</div>`;
            }

            const card = document.createElement('div');
            card.className = `card card-task p-3 ${isModified ? 'modified' : ''}`;
            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <span class="badge bg-secondary mb-2">#${task.id}</span> ${badgeHtml}
                        ${contentHtml}
                    </div>
                </div>
                <div class="btn-action-group">
                    <button class="btn btn-sm btn-rename flex-fill" onclick="openRename('${task.id}')">‚úèÔ∏è Renommer</button>
                    <button class="btn btn-sm btn-split flex-fill" onclick="openSplit('${task.id}')">‚úÇÔ∏è D√©couper</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // --- 3. LOGIQUE RENOMMER ---
    const renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
    
    function openRename(id) {
        const task = excelTasks.find(t => t.id === id);
        const mod = userModifications[id]; // Reprendre modif existante si y'a

        document.getElementById('renameTaskId').value = id;
        document.getElementById('renameOriginalTitle').innerText = task.originalTitle;
        
        // Si d√©j√† renomm√©, on reprend la valeur, sinon on pr√©pare avec [TATTOO] + titre original
        let val = (mod && mod.type === 'rename') ? mod.value : (PREFIX + task.originalTitle);
        // S'assurer que le prefixe est l√†
        if(!val.startsWith(PREFIX)) val = PREFIX + val;
        
        document.getElementById('renameInput').value = val;
        renameModal.show();
    }

    function confirmRename() {
        const id = document.getElementById('renameTaskId').value;
        let val = document.getElementById('renameInput').value.trim();
        
        // Force prefix
        if(!val.startsWith(PREFIX)) val = PREFIX + val;

        userModifications[id] = { type: 'rename', value: val, date: new Date().toISOString() };
        renameModal.hide();
        renderUserTasks();
    }

    // --- 4. LOGIQUE D√âCOUPER ---
    const splitModal = new bootstrap.Modal(document.getElementById('splitModal'));

    function openSplit(id) {
        const task = excelTasks.find(t => t.id === id);
        const mod = userModifications[id];

        document.getElementById('splitTaskId').value = id;
        document.getElementById('splitOriginalTitle').innerText = task.originalTitle;
        
        const container = document.getElementById('splitInputsContainer');
        container.innerHTML = "";

        // Si d√©j√† d√©coup√©, on charge les lignes, sinon 2 lignes vides par d√©faut
        const lines = (mod && mod.type === 'split') ? mod.lines : ["", ""];
        lines.forEach(line => addSplitLine(line));

        splitModal.show();
    }

    function addSplitLine(value = "") {
        // Ajoute le pr√©fixe si la ligne est vide ou nouvelle
        if(value === "") value = PREFIX;
        
        const div = document.createElement('div');
        div.className = "input-group mb-2";
        div.innerHTML = `
            <input type="text" class="form-control split-line-input" value="${value}">
            <button class="btn btn-outline-danger" onclick="this.parentElement.remove()">√ó</button>
        `;
        document.getElementById('splitInputsContainer').appendChild(div);
    }

    function confirmSplit() {
        const id = document.getElementById('splitTaskId').value;
        const inputs = document.querySelectorAll('.split-line-input');
        let lines = [];
        
        inputs.forEach(input => {
            let val = input.value.trim();
            if(val.length > 0 && val !== PREFIX.trim()) {
                 // Force prefix
                if(!val.startsWith(PREFIX)) val = PREFIX + val;
                lines.push(val);
            }
        });

        if(lines.length === 0) return alert("Veuillez saisir au moins une sous-t√¢che.");

        userModifications[id] = { type: 'split', lines: lines, date: new Date().toISOString() };
        splitModal.hide();
        renderUserTasks();
    }

    // --- 5. EXPORT / SAUVEGARDE (Bouton TERMINER) ---
    function exportUserWork() {
        if(Object.keys(userModifications).length === 0) return alert("Aucune modification √† enregistrer.");
        if(!currentUser) return alert("Aucun utilisateur s√©lectionn√©.");

        // Structure du fichier de sauvegarde
        const exportData = {
            user: currentUser,
            timestamp: new Date().toISOString(),
            modifications: userModifications
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // Nom de fichier standardis√©
        a.download = `TATTOO_SAUVEGARDE_${currentUser.replace(/\s+/g, '_')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // --- 6. ADMIN & IMPORT ---
    // Cl√© localStorage pour la base de donn√©es admin
    const ADMIN_DB_KEY = 'tattoo_admin_db';

    // Charger/Fusionner les sauvegardes
    document.getElementById('adminImportInput').addEventListener('change', async function(e) {
        const files = e.target.files;
        if(files.length === 0) return;

        let adminDB = JSON.parse(localStorage.getItem(ADMIN_DB_KEY) || "{}");
        let count = 0;

        for (let file of files) {
            try {
                const text = await file.text();
                const json = JSON.parse(text);
                
                if(json.user && json.modifications) {
                    // On √©crase les donn√©es de cet utilisateur avec sa version la plus r√©cente
                    adminDB[json.user] = json.modifications;
                    count++;
                }
            } catch (err) {
                console.error("Erreur lecture fichier", file.name, err);
            }
        }

        localStorage.setItem(ADMIN_DB_KEY, JSON.stringify(adminDB));
        alert(`${count} fichiers de sauvegarde import√©s avec succ√®s.`);
        renderAdminStats();
        // Reset input pour permettre de r√©importer le m√™me fichier si besoin
        e.target.value = '';
    });

    function renderAdminStats() {
        const tbody = document.getElementById('adminStatsBody');
        tbody.innerHTML = "";

        // R√©cup√©rer la DB Admin
        const adminDB = JSON.parse(localStorage.getItem(ADMIN_DB_KEY) || "{}");

        // Si l'Excel n'est pas charg√©, on ne peut pas faire de stats pr√©cises
        if(users.size === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Veuillez d'abord charger le fichier Excel principal √† l'accueil.</td></tr>`;
            return;
        }

        Array.from(users).sort().forEach(user => {
            // 1. Total t√¢ches dans l'Excel
            const userTotalTasks = excelTasks.filter(t => t.assignedTo.includes(user)).length;
            
            // 2. T√¢ches trait√©es dans la DB Admin
            const userMods = adminDB[user] || {};
            // On compte combien de t√¢ches de l'Excel ont une entr√©e dans les modifications
            // Attention : l'utilisateur a pu modifier des t√¢ches qui ne sont plus dans l'Excel (si l'Excel a chang√©),
            // mais on se base sur l'Excel charg√© comme r√©f√©rence.
            const excelIds = excelTasks.filter(t => t.assignedTo.includes(user)).map(t => t.id);
            const modifiedCount = excelIds.filter(id => userMods[id]).length;

            const pct = userTotalTasks > 0 ? Math.round((modifiedCount / userTotalTasks) * 100) : 0;
            let color = pct === 100 ? 'bg-success' : (pct > 0 ? 'bg-info' : 'bg-secondary');

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${user}</td>
                <td class="text-center fw-bold">${userTotalTasks}</td>
                <td class="text-center">${modifiedCount}</td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar ${color}" role="progressbar" style="width: ${pct}%">${pct}%</div>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function clearAdminData() {
        if(confirm("Effacer toutes les donn√©es consolid√©es du navigateur ?")) {
            localStorage.removeItem(ADMIN_DB_KEY);
            renderAdminStats();
        }
    }

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
