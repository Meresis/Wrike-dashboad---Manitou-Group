<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workload Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { --primary: #0d6efd; --bg: #f0f2f5; --kpi-h: 150px; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        .app-wrapper { width: 100%; max-width: 1700px; height: 100%; display: flex; flex-direction: column; padding: 20px; gap: 15px; }
        .panel { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }
        .top-bar { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn-unit { font-weight: bold; width: 35px; }
        .nav-tabs .nav-link { border: none; color: #6c757d; font-weight: 600; cursor: pointer; }
        .nav-tabs .nav-link.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: transparent; }
        .kpi-strip { display: flex; gap: 15px; height: var(--kpi-h); flex-shrink: 0; }
        .kpi-box { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border-bottom: 4px solid transparent; padding: 10px; }
        .kpi-box.primary { border-color: #0d6efd; } .kpi-box.dark { border-color: #212529; }
        .kpi-box.success { border-color: #198754; } .kpi-box.danger { border-color: #dc3545; }
        .kpi-box.info { border-color: #0dcaf0; }
        .kpi-val { font-size: 1.8rem; font-weight: 800; line-height: 1; margin: 5px 0; color: #1e293b; }
        .kpi-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; }
        .progress-stacked { height: 12px; width: 100%; border-radius: 6px; background-color: #e9ecef; display: flex; overflow: hidden; margin-bottom: 8px; }
        .progress-bar { display: flex; flex-direction: column; justify-content: center; color: #fff; text-align: center; white-space: nowrap; transition: width .6s ease; }
        .kpi-legend { display: flex; justify-content: space-between; width: 100%; font-size: 0.75rem; font-weight: 700; }
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .tab-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .tab-pane { height: 100%; display: flex; flex-direction: column; gap: 15px; }
        .active-tab { display: flex !important; } 
        .content-area { flex: 1; display: flex; gap: 15px; min-height: 0; }
        .chart-panel { flex: 1.2; display: flex; flex-direction: column; padding: 20px; }
        .chart-wrapper { flex: 1; position: relative; min-height: 0; width: 100%; }
        .table-panel { flex: 1; display: flex; flex-direction: column; padding: 0; overflow: hidden; }
        .table-header { padding: 12px 20px; border-bottom: 1px solid #eee; background: #f8f9fa; font-weight: bold; text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .table-scroll { flex: 1; overflow-y: auto; }
        .table-custom th { text-align: center; font-size: 0.75rem; text-transform: uppercase; background: #fff; position: sticky; top: 0; z-index: 5; }
        .table-custom td { vertical-align: middle; font-size: 0.85rem; }
        .sortable-th { cursor: pointer; user-select: none; position: sticky; top: 0; background: #f8f9fa; z-index: 10; border-bottom: 2px solid #dee2e6; }
        .sortable-th:hover { background-color: #e9ecef; }
        .sort-icon { font-size: 0.7em; margin-left: 5px; color: #999; }
        .active-sort .sort-icon { color: #0d6efd; }
        .heatmap-cell { font-weight: bold; color: white; border-radius: 4px; padding: 2px 6px; font-size: 0.8rem; }
        .bg-ok { background-color: #198754; }
        .bg-warn { background-color: #ffc107; color: #000; }
        .bg-danger { background-color: #dc3545; }
        .text-avail-pos { color: #198754; font-weight: bold; }
        .text-avail-neg { color: #dc3545; font-weight: bold; }
        .row-past { background-color: #e9ecef !important; color: #adb5bd !important; }
        #import-view { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 100; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .smart-dropzone { width: 800px; height: 300px; border: 3px dashed #cbd5e1; border-radius: 20px; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s; position: relative; }
        .smart-dropzone:hover { border-color: var(--primary); background-color: #f8fbff; transform: scale(1.01); }
        .status-indicators { display: flex; gap: 20px; margin-top: 30px; width: 800px; justify-content: center; }
        .status-badge { padding: 10px 20px; border-radius: 30px; background: #e9ecef; color: #adb5bd; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .status-badge.active { background: #198754; color: white; }
        .btn-go { margin-top: 30px; padding: 12px 40px; font-weight: bold; font-size: 1.2rem; border-radius: 30px; }
        .d-none { display: none !important; }
    </style>
</head>
<body>

<div id="import-view">
    <div class="text-center mb-5">
        <h1 class="fw-bold text-dark display-5">Workload <span class="text-primary">Management</span></h1>
        <p class="text-muted lead">Chargez vos 3 fichiers Excel simultan√©ment</p>
    </div>
    
    <div class="smart-dropzone" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div class="mb-3" style="font-size: 4rem;">üìÇ</div>
        <h4 class="fw-bold text-secondary">Glissez vos fichiers ici</h4>
        <input type="file" id="fileInput" multiple hidden onchange="handleSmartUpload(this.files)">
        <div id="loading-spinner" class="spinner-border text-primary d-none" role="status"></div>
    </div>

    <div class="status-indicators">
        <div class="status-badge" id="badge-workload"><span>üìä</span> Workload</div>
        <div class="status-badge" id="badge-run"><span>üõ†Ô∏è</span> Liste RUN</div>
        <div class="status-badge" id="badge-proj"><span>üöÄ</span> Liste PROJETS</div>
    </div>

    <button id="btn-launch" class="btn btn-primary btn-go disabled" onclick="launchDashboard()">ACC√âDER AU DASHBOARD</button>
</div>

<div id="dashboard-view" class="app-wrapper d-none">
    <div class="panel top-bar">
        <div class="d-flex align-items-center gap-3 w-100">
            <h5 class="fw-bold m-0 text-primary">Workload Management</h5>
            <div class="vr mx-2"></div>
            <div class="row g-2 w-100 align-items-center">
                <div class="col-md-4">
                    <div class="btn-group btn-group-sm w-100 shadow-sm hide-on-print">
                        <button class="btn btn-outline-primary fw-bold" onclick="setPeriod('today')">Aujourd'hui</button>
                        <button class="btn btn-outline-secondary" onclick="setPeriod('week')">Semaine</button>
                        <button class="btn btn-outline-secondary" onclick="setPeriod('month')">Mois</button>
                        <button class="btn btn-outline-secondary" onclick="setPeriod('year')">Ann√©e</button>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="input-group input-group-sm">
                        <input type="date" id="dStart" class="form-control fw-bold text-center" onchange="runEngine()">
                        <span class="input-group-text">‚ûù</span>
                        <input type="date" id="dEnd" class="form-control fw-bold text-center" onchange="runEngine()">
                    </div>
                </div>
                <div class="col-md-3 d-flex gap-1">
                    <select id="selCollab" class="form-select form-select-sm fw-bold" onchange="runEngine()">
                        <option value="ALL">Vue d'Equipe</option>
                    </select>
                    <button class="btn btn-sm btn-outline-dark hide-on-print" onclick="openConfig()">‚öôÔ∏è</button>
                </div>
                <div class="col-md-2 text-end d-flex gap-2 justify-content-end align-items-center hide-on-print">
                    <button class="btn btn-sm btn-outline-success" onclick="exportPDF()">üìÑ PDF</button>
                    <div class="btn-group btn-group-sm shadow-sm">
                        <button type="button" class="btn btn-primary btn-unit" id="btn-unit-h" onclick="setUnit('h')">H</button>
                        <button type="button" class="btn btn-outline-primary btn-unit" id="btn-unit-j" onclick="setUnit('j')">J</button>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearData()">Exit</button>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs ps-3 border-bottom-0 hide-on-print">
        <li class="nav-item"><button class="nav-link active" onclick="switchTab('overview')">Synth√®se</button></li>
        <li class="nav-item"><button class="nav-link d-none" id="tab-opti" onclick="switchTab('opti')">‚ú® Optimisation</button></li>
    </ul>

    <div class="tab-content">
        <div id="view-overview" class="tab-pane active-tab">
            <div class="kpi-strip">
                <div class="panel kpi-box primary">
                    <div class="kpi-label">Charge</div><div class="kpi-val text-primary" id="k-load">0 h</div>
                </div>
                <div class="panel kpi-box dark">
                    <div class="kpi-label">Capacit√©</div><div class="kpi-val" id="k-capa">0 h</div>
                </div>
                <div class="panel kpi-box success" id="box-dispo">
                    <div class="kpi-label">Disponibilit√©</div><div class="kpi-val text-success" id="k-dispo">0 h</div>
                </div>
                <div class="panel kpi-box info" style="flex:2;">
                    <div class="kpi-label mb-2">R√©partition</div>
                    <div class="progress-stacked">
                        <div class="progress-bar" id="pb-run" style="background-color: #0d6efd;"></div>
                        <div class="progress-bar" id="pb-proj" style="background-color: #f59e0b;"></div>
                        <div class="progress-bar" id="pb-other" style="background-color: #ced4da;"></div>
                    </div>
                    <div class="kpi-legend mt-1">
                        <div class="legend-item" style="color: #0d6efd;"><span>RUN:</span><span id="val-run">0h</span></div>
                        <div class="legend-item" style="color: #f59e0b;"><span>PROJ:</span><span id="val-proj">0h</span></div>
                        <div class="legend-item" style="color: #6c757d;"><span>AUTRE:</span><span id="val-other">0h</span></div>
                    </div>
                </div>
            </div>
            <div class="content-area">
                <div class="panel chart-panel">
                    <div class="chart-wrapper"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="panel table-panel">
                    <div class="table-header">
                        <span id="top-tasks-title">Synth√®se Collaborateurs</span>
                    </div>
                    <div class="table-scroll">
                        <div id="heatmap-container" class="d-none">
                            <table class="table table-sm table-bordered text-center mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="sortable-th" onclick="sortTeamTable('user')">Collab ‚áÖ</th>
                                        <th class="sortable-th" onclick="sortTeamTable('load')">Charge ‚áÖ</th>
                                        <th class="sortable-th" onclick="sortTeamTable('dispo')">Dispo ‚áÖ</th>
                                        <th class="sortable-th" onclick="sortTeamTable('occ')">% ‚áÖ</th>
                                    </tr>
                                </thead>
                                <tbody id="heatmap-body"></tbody>
                            </table>
                        </div>
                        <table class="table table-hover table-striped table-sm mb-0 table-custom" id="top-proj"><tbody></tbody></table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let WORKLOAD_RAW=[], REF_RUN=new Set(), REF_PROJ=new Set(), DATA=[];
    let USER_CAPA = JSON.parse(localStorage.getItem('wrike_user_capa') || '{}');
    let filesLoaded={workload:false,run:false,proj:false};
    let DISPLAY_UNIT = 'h';
    let teamSortCol = 'user', teamSortAsc = true;
    let currentTeamData = [];

    // --- IMPORT SYSTEM ---
    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleSmartUpload(e.dataTransfer.files); });

    function handleSmartUpload(files) {
        if(files.length === 0) return;
        document.getElementById('loading-spinner').classList.remove('d-none');
        const promises = Array.from(files).map(file => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wb = XLSX.read(e.target.result, {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                    resolve({ name: file.name.toLowerCase(), data: json });
                };
                reader.readAsArrayBuffer(file);
            });
        });
        Promise.all(promises).then(results => {
            results.forEach(res => identifyAndAssign(res));
            document.getElementById('loading-spinner').classList.add('d-none');
            if(filesLoaded.workload) document.getElementById('btn-launch').classList.remove('disabled');
        });
    }

    function identifyAndAssign(fileObj) {
        const json = fileObj.data;
        const name = fileObj.name;
        let isWorkload = json.slice(0, 20).some(row => row.some(cell => /Allocated effort|Effort allou√©/i.test(String(cell))));
        if (isWorkload) {
            WORKLOAD_RAW = json;
            filesLoaded.workload = true;
            document.getElementById('badge-workload').classList.add('active');
        } else if (name.includes('run')) {
            extractRefProjects(json, REF_RUN);
            filesLoaded.run = true;
            document.getElementById('badge-run').classList.add('active');
        } else if (name.includes('proj')) {
            extractRefProjects(json, REF_PROJ);
            filesLoaded.proj = true;
            document.getElementById('badge-proj').classList.add('active');
        }
    }

    function extractRefProjects(rows, targetSet) {
        let hIdx = rows.findIndex(row => row.some(c => /projet ou dossier|nom/i.test(String(c))));
        if(hIdx === -1) return;
        const colIdx = rows[hIdx].findIndex(c => /projet ou dossier|nom/i.test(String(c)));
        for(let i=hIdx+1; i<rows.length; i++) {
            const val = String(rows[i][colIdx] || '').trim();
            if(val) targetSet.add(val.toUpperCase());
        }
    }

    // --- DASHBOARD LOGIC ---
    function launchDashboard() {
        processData();
        document.getElementById('import-view').classList.add('d-none');
        document.getElementById('dashboard-view').classList.remove('d-none');
        initFilters();
    }

    function processData() {
        const rows = WORKLOAD_RAW;
        let hIdx = rows.findIndex(row => row.some(cell => /Allocated effort|Effort allou√©/i.test(String(cell))));
        const headers = rows[hIdx].map(h => String(h).trim());
        let dateCols = [];
        headers.forEach((h, idx) => {
            let m = h.match(/(\d{1,2}.*?\d{4})/);
            if(m) {
                // Simplification du parsing date pour robustesse
                const parts = m[1].split(/[\s.]+/);
                if(parts.length >= 3) {
                    const months={'jan':0,'janv':0,'feb':1,'fev':1,'f√©vr':1,'mar':2,'mars':2,'apr':3,'avr':3,'may':4,'mai':4,'jun':5,'juin':5,'jul':6,'juil':6,'aug':7,'aout':7,'sep':8,'oct':9,'nov':10,'dec':11,'d√©c':11};
                    const d = new Date(parseInt(parts[2]), months[parts[1].toLowerCase().substring(0,3)], parseInt(parts[0]));
                    dateCols.push({idx, date: d});
                }
            }
        });

        const cAss = headers.findIndex(h => /assignee/i.test(h));
        const cProj = headers.findIndex(h => /project name/i.test(h));
        DATA = [];
        for(let i=hIdx+1; i<rows.length; i++) {
            const r = rows[i];
            const assignee = String(r[cAss] || 'Inconnu').trim();
            const proj = String(r[cProj] || 'Sans Projet').trim();
            let cat = 'AUTRES';
            if(REF_RUN.has(proj.toUpperCase())) cat = 'RUN';
            else if(REF_PROJ.has(proj.toUpperCase())) cat = 'PROJETS';
            
            let vals = [];
            dateCols.forEach(col => {
                let v = parseFloat(String(r[col.idx]).replace(',','.')) || 0;
                if(v !== 0) vals.push({d: col.date, v: v});
            });
            if(vals.length > 0) DATA.push({ assignee, project: proj, category: cat, values: vals });
        }
    }

    function initFilters() {
        const sel = document.getElementById('selCollab');
        const s = new Set(DATA.map(d => d.assignee));
        sel.innerHTML = '<option value="ALL">Vue d\'Equipe</option>';
        Array.from(s).sort().forEach(u => sel.innerHTML += `<option value="${u}">${u}</option>`);
        setPeriod('week');
    }

    function setPeriod(mode) {
        const now = new Date();
        let s = new Date(now), e = new Date(now);
        if(mode === 'week') { s.setDate(now.getDate() - (now.getDay()||7) + 1); e.setDate(s.getDate() + 6); }
        else if(mode === 'month') { s.setDate(1); e = new Date(s.getFullYear(), s.getMonth()+1, 0); }
        document.getElementById('dStart').value = s.toISOString().split('T')[0];
        document.getElementById('dEnd').value = e.toISOString().split('T')[0];
        runEngine();
    }

    let chart;
    function runEngine() {
        const start = new Date(document.getElementById('dStart').value);
        const end = new Date(document.getElementById('dEnd').value);
        const who = document.getElementById('selCollab').value;
        
        let totLoad = 0, cats = {RUN:0, PROJETS:0, AUTRES:0}, projs = {}, daily = {};
        let team = {};

        DATA.forEach(r => {
            if(who !== 'ALL' && r.assignee !== who) return;
            if(!team[r.assignee]) team[r.assignee] = { load:0, capa: 40 };
            
            r.values.forEach(v => {
                if(v.d >= start && v.d <= end) {
                    totLoad += v.v;
                    cats[r.category] += v.v;
                    projs[r.project] = (projs[r.project] || 0) + v.v;
                    const dk = v.d.toLocaleDateString();
                    if(!daily[dk]) daily[dk] = {RUN:0, PROJETS:0, AUTRES:0};
                    daily[dk][r.category] += v.v;
                    team[r.assignee].load += v.v;
                }
            });
        });

        // UI Updates
        document.getElementById('k-load').innerText = totLoad.toFixed(1) + ' h';
        document.getElementById('val-run').innerText = cats.RUN.toFixed(1) + ' h';
        document.getElementById('val-proj').innerText = cats.PROJETS.toFixed(1) + ' h';
        document.getElementById('val-other').innerText = cats.AUTRES.toFixed(1) + ' h';
        
        const tot = Math.max(totLoad, 1);
        document.getElementById('pb-run').style.width = (cats.RUN/tot*100) + '%';
        document.getElementById('pb-proj').style.width = (cats.PROJETS/tot*100) + '%';
        document.getElementById('pb-other').style.width = (cats.AUTRES/tot*100) + '%';

        renderChart(daily);
        
        // Heatmap simple
        const hb = document.getElementById('heatmap-body');
        hb.innerHTML = '';
        if(who === 'ALL') {
            document.getElementById('heatmap-container').classList.remove('d-none');
            Object.entries(team).forEach(([u, d]) => {
                const occ = (d.load/40*100).toFixed(0);
                hb.innerHTML += `<tr><td>${u}</td><td>${d.load.toFixed(1)}h</td><td>${(40-d.load).toFixed(1)}h</td><td>${occ}%</td></tr>`;
            });
        }
    }

    function renderChart(daily) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chart) chart.destroy();
        const labels = Object.keys(daily).sort();
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    { label: 'RUN', data: labels.map(l => daily[l].RUN), backgroundColor: '#0d6efd' },
                    { label: 'PROJETS', data: labels.map(l => daily[l].PROJETS), backgroundColor: '#f59e0b' }
                ]
            },
            options: { maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
        });
    }

    async function exportPDF() {
        const canvas = await html2canvas(document.getElementById('dashboard-view'));
        const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, 277, 190);
        pdf.save('Workload_Report.pdf');
    }

    function clearData() { location.reload(); }
    function setUnit(u) { DISPLAY_UNIT = u; runEngine(); }
    function switchTab(t) { /* Navigation simple */ }
</script>
</body>
</html>
