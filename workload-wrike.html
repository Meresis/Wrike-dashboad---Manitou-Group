<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrike Pilotage v11.0 - Manitou Group</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary-color: #e2001a; /* Rouge Manitou */
            --bg-color: #f4f7f6;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --text-color: #333;
            --transition: all 0.3s ease;
            --kpi-h: 150px; 
        }
        
        body { 
            background-color: var(--bg-color); font-family: 'Segoe UI', sans-serif; 
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: row; margin: 0;
        }

        /* --- Sidebar Manitou --- */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            height: 100vh;
            position: sticky;
            top: 0;
        }

        .sidebar-brand {
            padding: 20px;
            font-size: 1.5rem;
            font-weight: bold;
            background-color: rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .nav-links {
            list-style: none; padding: 0; margin: 0;
            display: flex; flex-direction: column; gap: 5px;
        }

        .nav-links a {
            display: flex; align-items: center; padding: 15px 25px;
            color: #bdc3c7; text-decoration: none; transition: var(--transition); font-size: 1rem;
        }

        .nav-links a:hover, .nav-links a.active {
            background-color: var(--sidebar-hover);
            color: #fff; border-left: 4px solid var(--primary-color);
        }

        .nav-links a i { margin-right: 15px; width: 20px; text-align: center; font-style: normal; }

        /* --- Zone Contenu --- */
        .main-content {
            flex-grow: 1; display: flex; flex-direction: column; padding: 20px; gap: 15px;
            height: 100vh; overflow-y: auto;
        }

        .panel { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }

        .top-bar { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn-unit { font-weight: bold; width: 35px; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); color: white !important; }
        .btn-outline-primary { color: var(--primary-color); border-color: var(--primary-color); }
        .btn-outline-primary:hover { background-color: var(--primary-color); color: white; }

        /* KPIs */
        .kpi-strip { display: flex; gap: 15px; height: var(--kpi-h); flex-shrink: 0; }
        .kpi-box { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border-bottom: 4px solid transparent; padding: 10px; }
        .kpi-box.primary { border-color: #0d6efd; } .kpi-box.dark { border-color: #212529; }
        .kpi-box.success { border-color: #198754; } .kpi-box.info { border-color: #0dcaf0; }
        
        .kpi-val { font-size: 1.8rem; font-weight: 800; line-height: 1; margin: 5px 0; color: #1e293b; }
        .kpi-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; }
        
        /* R√©partition Bar */
        .progress-stacked { height: 12px; width: 100%; border-radius: 6px; background-color: #e9ecef; display: flex; overflow: hidden; margin-bottom: 8px; }
        .progress-bar { display: flex; flex-direction: column; justify-content: center; color: #fff; text-align: center; white-space: nowrap; transition: width .6s ease; }
        .kpi-legend { display: flex; justify-content: space-between; width: 100%; font-size: 0.75rem; font-weight: 700; }

        /* Tabs */
        .nav-tabs .nav-link { border: none; color: #6c757d; font-weight: 600; cursor: pointer; }
        .nav-tabs .nav-link.active { color: var(--primary-color); border-bottom: 3px solid var(--primary-color); background: transparent; }

        /* Table Styles */
        .table-custom th { text-align: center; font-size: 0.75rem; text-transform: uppercase; background: #fff; position: sticky; top: 0; }
        .table-custom td { vertical-align: middle; font-size: 0.85rem; }
        .row-past td { background-color: #e9ecef !important; color: #adb5bd !important; }

        /* Import & Loading */
        #import-view { 
            position: absolute; top:0; right:0; width: calc(100% - 250px); height:100%; 
            z-index: 100; background: var(--bg-color); display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        .import-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; width: 900px; }
        .upload-card { 
            border: 2px dashed #cbd5e1; padding: 30px 20px; text-align: center; background: white; border-radius: 12px; cursor: pointer; height: 220px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.2s; position: relative;
        }
        .upload-card.done { border-color: #198754; background: #d1e7dd; }
        .upload-card.loading { border-color: #ffc107; background: #fff3cd; cursor: wait; }
        .spinner-border { width: 3rem; height: 3rem; }
        .btn-go { grid-column: span 3; padding: 15px; font-weight: bold; font-size: 1.2rem; background-color: var(--primary-color); border: none; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-brand">Manitou Wrike</div>
        <div class="nav-links">
            <a href="https://meresis.github.io/Wrike-dashboad---Manitou-Group/"><i>üè†</i> Accueil</a>
            <a href="https://meresis.github.io/Wrike-dashboad---Manitou-Group/workload-wrike.html" class="active"><i>üìä</i> Workload</a>
            <a href="https://meresis.github.io/Wrike-dashboad---Manitou-Group/dragonfly-2025.html"><i>üêâ</i> Dragonfly 2025</a>
            <a href="https://meresis.github.io/Wrike-dashboad---Manitou-Group/pointages-wrike.html"><i>‚è±Ô∏è</i> Pointages</a>
        </div>
    </nav>

    <div class="main-content">
        
        <div id="import-view">
            <h2 class="fw-bold mb-4 text-dark">Wrike Pilotage <span style="color: var(--primary-color);">v11.0</span></h2>
            <div class="import-grid">
                <div class="upload-card" id="card-workload" onclick="triggerFile('fileWorkload')">
                    <div id="icon-workload" class="fs-1 mb-2">üìä</div>
                    <div id="spin-workload" class="spinner-border text-warning mb-2 d-none"></div>
                    <h6 class="fw-bold">1. Workload</h6>
                    <div class="small text-muted" id="txt-workload">Matrice des charges</div>
                    <input type="file" id="fileWorkload" hidden onchange="handleFile(this, 'workload')">
                </div>
                <div class="upload-card" id="card-run" onclick="triggerFile('fileRun')">
                    <div id="icon-run" class="fs-1 mb-2">üõ†Ô∏è</div>
                    <div id="spin-run" class="spinner-border text-warning mb-2 d-none"></div>
                    <h6 class="fw-bold">2. Liste RUN</h6>
                    <div class="small text-muted" id="txt-run">R√©f√©rentiel RUN</div>
                    <input type="file" id="fileRun" hidden onchange="handleFile(this, 'run')">
                </div>
                <div class="upload-card" id="card-proj" onclick="triggerFile('fileProj')">
                    <div id="icon-proj" class="fs-1 mb-2">üöÄ</div>
                    <div id="spin-proj" class="spinner-border text-warning mb-2 d-none"></div>
                    <h6 class="fw-bold">3. Liste PROJETS</h6>
                    <div class="small text-muted" id="txt-proj">R√©f√©rentiel PROJETS</div>
                    <input type="file" id="fileProj" hidden onchange="handleFile(this, 'proj')">
                </div>
                <button id="btn-launch" class="btn btn-primary btn-go disabled" onclick="launchDashboard()">LANCER LE CROISEMENT</button>
            </div>
            <div id="log" class="mt-3 text-danger font-monospace fw-bold"></div>
        </div>

        <div id="dashboard-view" class="d-none flex-column gap-3 w-100">
            <div class="panel top-bar">
                <div class="d-flex align-items-center gap-3 w-100">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="setPeriod('week')">Semaine</button>
                        <button class="btn btn-outline-primary" onclick="setPeriod('month')">Mois</button>
                    </div>
                    <div class="d-flex gap-2">
                        <input type="date" id="dStart" class="form-control form-control-sm" onchange="runEngine()">
                        <input type="date" id="dEnd" class="form-control form-control-sm" onchange="runEngine()">
                    </div>
                    <select id="selCollab" class="form-select form-select-sm w-auto" onchange="runEngine()">
                        <option value="ALL">Vue d'Equipe</option>
                    </select>
                    <div class="ms-auto btn-group btn-group-sm">
                        <button type="button" class="btn btn-primary btn-unit" id="btn-unit-h" onclick="setUnit('h')">H</button>
                        <button type="button" class="btn btn-outline-primary btn-unit" id="btn-unit-j" onclick="setUnit('j')">J</button>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs ps-3 border-bottom-0" id="mainTabs">
                <li class="nav-item"><button class="nav-link active" id="tab-overview" onclick="switchTab('overview')">Synth√®se</button></li>
                <li class="nav-item"><button class="nav-link d-none" id="tab-opti" onclick="switchTab('opti')">‚ú® Optimisation de Charge</button></li>
            </ul>

            <div class="tab-content" id="tabContent">
                <div id="view-overview" class="tab-pane active-tab flex-column gap-3">
                    <div class="kpi-strip">
                        <div class="panel kpi-box primary"><div class="kpi-label">Charge</div><div class="kpi-val" id="k-load">0</div></div>
                        <div class="panel kpi-box dark"><div class="kpi-label">Capacit√© (8h)</div><div class="kpi-val" id="k-capa">0</div></div>
                        <div class="panel kpi-box success" id="box-dispo"><div class="kpi-label">Disponibilit√©</div><div class="kpi-val" id="k-dispo">0</div></div>
                        <div class="panel kpi-box info" style="flex:2;">
                            <div class="kpi-label mb-3">R√©partition</div>
                            <div class="progress-stacked">
                                <div class="progress-bar" id="pb-run" style="background-color: #0d6efd;"></div>
                                <div class="progress-bar" id="pb-proj" style="background-color: #f59e0b;"></div>
                                <div class="progress-bar" id="pb-other" style="background-color: #ced4da;"></div>
                            </div>
                            <div class="kpi-legend">
                                <span id="val-run" style="color: #0d6efd">0%</span>
                                <span id="val-proj" style="color: #f59e0b">0%</span>
                                <span id="val-other" style="color: #6c757d">0%</span>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-3 h-100">
                        <div class="panel p-3 flex-grow-1"><canvas id="mainChart"></canvas></div>
                        <div class="panel w-25 overflow-auto">
                            <table class="table table-sm table-hover" id="top-proj">
                                <thead class="sticky-top bg-white"><tr><th>T√¢ches</th><th class="text-end" id="badge-table-unit">H</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-opti" class="tab-pane d-none flex-column h-100">
                    <div class="panel h-100 overflow-auto">
                        <div class="p-3 border-bottom d-flex justify-content-between">
                            <h6 class="m-0 fw-bold">üîç Vue Annuelle : <span id="opti-user-name"></span></h6>
                            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="chk-hide-past" onchange="renderOptiTableInternal()"><label class="form-check-label small">Masquer pass√©</label></div>
                        </div>
                        <table class="table table-bordered text-center m-0" id="opti-table">
                            <thead><tr class="table-light"><th class="opti-th" onclick="sortOptiTable('label')">P√©riode</th><th>Jours</th><th>Capa</th><th>Charge</th><th>Dispo</th><th>Occ.</th><th>Statut</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    let WORKLOAD_RAW=[], REF_RUN=new Set(), REF_PROJ=new Set(), DATA=[]; 
    let DISPLAY_UNIT='h', optiSortCol='label', optiSortAsc=true, optiMode='week';
    let filesLoaded={workload:false,run:false,proj:false};

    function triggerFile(id) { document.getElementById(id).click(); }

    function handleFile(input, type) {
        const card=document.getElementById('card-'+type), icon=document.getElementById('icon-'+type), spin=document.getElementById('spin-'+type), txt=document.getElementById('txt-'+type);
        card.classList.add('loading'); icon.classList.add('d-none'); spin.classList.remove('d-none'); txt.innerText = "Lecture...";

        setTimeout(() => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const wb = XLSX.read(e.target.result, {type:'array'});
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                    if(type==='workload') { WORKLOAD_RAW=json; filesLoaded.workload=true; }
                    else if(type==='run') extractRef(json, REF_RUN);
                    else extractRef(json, REF_PROJ);
                    card.classList.replace('loading','done'); spin.classList.add('d-none'); icon.classList.remove('d-none'); icon.innerHTML="‚úÖ"; txt.innerText="Charg√©";
                    if(filesLoaded.workload) document.getElementById('btn-launch').classList.remove('disabled');
                } catch(err) { alert(err.message); }
            };
            reader.readAsArrayBuffer(input.files[0]);
        }, 100);
    }

    function extractRef(rows, targetSet) {
        let idx=-1;
        for(let i=0; i<Math.min(20, rows.length); i++) {
            let row=rows[i].map(x=>String(x).toLowerCase());
            if(row.includes('projet ou dossier')) { idx=row.indexOf('projet ou dossier'); break; }
            if(row.includes('nom')) { idx=row.indexOf('nom'); break; }
        }
        for(let i=1; i<rows.length; i++) if(rows[i][idx]) targetSet.add(String(rows[i][idx]).trim().toUpperCase());
    }

    function launchDashboard() {
        processData();
        document.getElementById('import-view').classList.add('d-none');
        document.getElementById('dashboard-view').classList.remove('d-none');
        document.getElementById('dashboard-view').style.display = 'flex';
        initFilters();
        setPeriod('week');
    }

    function processData() {
        const rows=WORKLOAD_RAW;
        let hIdx=rows.findIndex(r=>r.some(c=>String(c).includes('Allocated effort')));
        const headers=rows[hIdx];
        const cAss=headers.findIndex(h=>h.toLowerCase().includes('assignee'));
        const cProj=headers.findIndex(h=>h.toLowerCase().includes('project name'));
        let dateCols=[];
        headers.forEach((h,i)=>{
            let m=String(h).match(/(\d{1,2}.*?\d{4})/);
            if(m) dateCols.push({idx:i, date:new Date(m[0])});
        });
        DATA=[];
        for(let i=hIdx+1; i<rows.length; i++){
            let r=rows[i]; if(String(r[0]).includes('Total')) continue;
            let proj=String(r[cProj]||'').trim();
            let cat=REF_RUN.has(proj.toUpperCase())?'RUN':(REF_PROJ.has(proj.toUpperCase())?'PROJETS':'AUTRE');
            let vals=[];
            dateCols.forEach(dc=>{
                let v=parseFloat(String(r[dc.idx]).replace(',','.'))||0;
                if(v>0) vals.push({d:dc.date, v:v});
            });
            if(vals.length>0) DATA.push({ assignee:String(r[cAss]||'Inconnu'), project:proj, category:cat, values:vals });
        }
    }

    function initFilters() {
        const sel=document.getElementById('selCollab');
        [...new Set(DATA.map(d=>d.assignee))].sort().forEach(a=>sel.innerHTML+=`<option value="${a}">${a}</option>`);
    }

    function setPeriod(mode) {
        let now=new Date(), s=new Date(now), e=new Date(now);
        if(mode==='week') { s.setDate(now.getDate()-now.getDay()+1); e.setDate(s.getDate()+6); }
        else { s.setDate(1); e=new Date(now.getFullYear(),now.getMonth()+1,0); }
        document.getElementById('dStart').value=s.toISOString().split('T')[0];
        document.getElementById('dEnd').value=e.toISOString().split('T')[0];
        runEngine();
    }

    function setUnit(u) {
        DISPLAY_UNIT=u;
        document.getElementById('btn-unit-h').className = u==='h'?'btn btn-primary':'btn btn-outline-primary';
        document.getElementById('btn-unit-j').className = u==='j'?'btn btn-primary':'btn btn-outline-primary';
        runEngine();
    }

    function runEngine() {
        const sVal=document.getElementById('dStart').value, eVal=document.getElementById('dEnd').value, who=document.getElementById('selCollab').value;
        if(!sVal || !eVal) return;
        const s=new Date(sVal), e=new Date(eVal), div=DISPLAY_UNIT==='h'?1:8;

        document.getElementById('tab-opti').classList.toggle('d-none', who==='ALL');
        
        let tot=0, cats={'RUN':0,'PROJETS':0,'AUTRE':0}, daily={}, projs={};
        DATA.filter(d=>who==='ALL'||d.assignee===who).forEach(d=>{
            d.values.forEach(v=>{
                if(v.d>=s && v.d<=e) {
                    tot+=v.v; cats[d.category]+=v.v;
                    let k=v.d.toLocaleDateString(); daily[k]=(daily[k]||0)+v.v;
                    projs[d.project]=(projs[d.project]||0)+v.v;
                }
            });
        });

        const fmt = (val) => (val/div).toFixed(1) + (DISPLAY_UNIT==='h'?'h':'j');
        document.getElementById('k-load').innerText=fmt(tot);
        document.getElementById('pb-run').style.width=(cats.RUN/tot*100||0)+'%';
        document.getElementById('pb-proj').style.width=(cats.PROJETS/tot*100||0)+'%';
        document.getElementById('pb-other').style.width=(cats.AUTRE/tot*100||0)+'%';
        document.getElementById('val-run').innerText=`RUN: ${(cats.RUN/tot*100||0).toFixed(0)}%`;
        document.getElementById('val-proj').innerText=`PROJ: ${(cats.PROJETS/tot*100||0).toFixed(0)}%`;

        renderChart(daily);
        const tb=document.querySelector('#top-proj tbody'); tb.innerHTML='';
        Object.entries(projs).sort((a,b)=>b[1]-a[1]).forEach(([n,v])=>tb.innerHTML+=`<tr><td>${n}</td><td class="text-end fw-bold">${fmt(v)}</td></tr>`);
    }

    function renderChart(data) {
        const ctx=document.getElementById('mainChart').getContext('2d');
        if(window.myChart) window.myChart.destroy();
        window.myChart=new Chart(ctx,{type:'bar',data:{labels:Object.keys(data),datasets:[{label:'Charge',data:Object.values(data),backgroundColor:'#e2001a'}]},options:{maintainAspectRatio:false}});
    }

    function switchTab(t) {
        document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(p=>p.classList.add('d-none'));
        document.getElementById('tab-'+t).classList.add('active');
        document.getElementById('view-'+t).classList.replace('d-none','active-tab');
    }
</script>
</body>
</html>
