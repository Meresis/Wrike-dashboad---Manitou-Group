<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse Dragonfly v2.6 + Sidebar</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        :root {
            --primary-color: #e2001a; /* Rouge Manitou */
            --bg-color: #f4f7f6;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex; /* Structure Menu / Contenu */
            flex-direction: row;
            min-height: 100vh;
        }

        /* --- Sidebar Placeholder --- */
        #menu-placeholder {
            width: 250px;
            flex-shrink: 0;
            z-index: 1000;
        }

        /* --- Zone de contenu principal --- */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            max-width: calc(100% - 250px);
        }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        th { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; font-weight: 700; background-color: #f8fafc; padding: 12px 16px; text-align: left; }
        td { padding: 8px 16px; border-bottom: 1px solid #f1f5f9; color: #334155; font-size: 0.9rem; vertical-align: middle; }
        .macro-header { background-color: #312e81; color: white; }
        
        .modal { transition: opacity 0.25s ease; z-index: 2000; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }

        .reservoir-container { background: #f1f5f9; border-radius: 1rem; position: relative; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .reservoir-liquid { background: linear-gradient(to top, #64748b, #94a3b8); width: 100%; position: absolute; bottom: 0; left: 0; transition: height 1s ease-in-out; border-top: 2px solid #475569; z-index: 10; }
        .reservoir-project { background: linear-gradient(to bottom, #dcfce7, #bbf7d0); position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: height 1s ease-in-out; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 20px; z-index: 1; }
        
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; background-color: #eef2ff; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #374151; border-color: #cbd5e1; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="menu-placeholder"></div>

    <div class="main-content">
        <div class="max-w-6xl mx-auto">
            
            <header class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-3">
                    <h1 class="text-3xl font-extrabold text-indigo-900 tracking-tight">Analyse Dragonfly</h1>
                    <span class="text-xs font-mono font-bold text-white bg-indigo-600 px-2 py-1 rounded shadow">v2.6</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleModal()" class="flex items-center gap-2 bg-white text-slate-700 px-4 py-2 rounded-lg shadow border border-slate-300 hover:bg-slate-50 transition-colors font-semibold text-sm">
                        ‚öôÔ∏è Param√®tres
                    </button>
                    <div id="statusBadge" class="hidden px-4 py-2 bg-green-100 text-green-700 font-bold rounded-lg text-xs border border-green-200">Donn√©es actives ‚úî</div>
                </div>
            </header>

            <div id="uploadZone" class="bg-white border-2 border-dashed border-indigo-200 rounded-2xl p-10 text-center hover:border-indigo-500 hover:bg-indigo-50 transition-all cursor-pointer relative shadow-sm">
                <input type="file" id="fileInput" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                <div class="space-y-2 pointer-events-none">
                    <p class="text-lg font-medium text-slate-700">Cliquez pour importer votre Excel Dragonfly</p>
                    <p class="text-xs text-slate-400 mt-2">N√©cessaire une fois par session.</p>
                </div>
            </div>

            <div id="dashboard" class="hidden mt-8 space-y-6">
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col sm:flex-row gap-6 items-end">
                    <div class="flex-1 w-full">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Collaborateur</label>
                        <select id="userSelect" class="w-full pl-4 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 font-semibold focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="">Chargement...</option>
                        </select>
                    </div>
                    <div class="w-full sm:w-48">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Ann√©e Source</label>
                        <select id="yearSelect" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-lg font-medium outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                        </select>
                    </div>
                    <div class="bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-100 text-center min-w-[120px]">
                        <p class="text-xs text-indigo-400 uppercase font-bold text-[10px]">Jours Saisis</p>
                        <p class="text-xl font-extrabold text-indigo-700" id="detectedDaysCount">-</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-1 flex">
                    <button onclick="switchTab('tab1')" id="btn-tab1" class="tab-active flex-1 py-3 rounded-md font-bold text-xs transition-all">1. Affectation</button>
                    <button onclick="switchTab('tab2')" id="btn-tab2" class="tab-inactive flex-1 py-3 rounded-md font-medium text-xs transition-all">2. Analyse</button>
                    <button onclick="switchTab('tab3')" id="btn-tab3" class="tab-inactive flex-1 py-3 rounded-md font-medium text-xs transition-all">3. Projections 2026</button>
                </div>

                <div id="tab1" class="fade-in space-y-6">
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                        <table class="w-full">
                            <thead>
                                <tr><th>T√¢che</th><th class="bg-indigo-50">Cat√©gorie</th><th class="text-right">Heures Totales</th><th class="text-right bg-amber-50">Moy. Jour</th></tr>
                            </thead>
                            <tbody id="statsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative">
                        <h3 class="text-sm font-bold text-slate-700 mb-2 border-b pb-2 uppercase">üìä R√©partition des Temps (Tri√©)</h3>
                        <div style="height: 300px;"><canvas id="distributionChart"></canvas></div>
                    </div>
                </div>

                <div id="tab2" class="hidden fade-in space-y-8">
                    <div class="bg-white rounded-xl shadow-lg border border-slate-200 p-6 flex flex-col md:flex-row gap-8 items-center">
                        <div class="h-48 w-32 reservoir-container border-2 border-slate-300 relative">
                            <div id="reservoirProject" class="reservoir-project"><span class="text-green-800 font-bold text-[10px] uppercase">Capacit√©</span><span class="text-green-900 font-extrabold text-xs uppercase">Projet</span></div>
                            <div id="reservoirLiquid" class="reservoir-liquid"></div>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-slate-800 mb-2 uppercase tracking-wide">Moyenne Annuelle (Base 8h)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-green-50 border border-green-200 p-4 rounded-xl">
                                    <p class="text-xs font-bold text-green-700 uppercase">Capacit√© Projet</p>
                                    <p class="text-3xl font-extrabold text-green-600 mt-1" id="kpiProjectCapacity">0.00 h</p>
                                </div>
                                <div class="bg-slate-100 border border-slate-200 p-4 rounded-xl opacity-80">
                                    <p class="text-xs font-bold text-slate-500 uppercase">Charge Hors-Projet</p>
                                    <p class="text-2xl font-bold text-slate-600 mt-1" id="kpiRunLoad">0.00 h</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative">
                        <h3 class="text-sm font-bold text-slate-700 mb-2 border-b pb-2 uppercase tracking-wider">üìÖ Saisonnalit√© (Mensuelle)</h3>
                        <div style="height: 300px;"><canvas id="trendChart"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg border border-indigo-900 overflow-hidden">
                        <table class="w-full"><thead><tr><th class="macro-header w-1/3">Cat√©gorie</th><th class="macro-header text-right">Total</th><th class="macro-header text-right bg-indigo-800">Moy. Jour</th></tr></thead><tbody id="macroTableBody"></tbody></table>
                    </div>
                </div>

                <div id="tab3" class="hidden fade-in space-y-6">
                    <div class="bg-gradient-to-r from-indigo-900 to-indigo-700 text-white p-6 rounded-xl shadow-lg flex flex-col md:flex-row justify-between items-center">
                        <div><h2 class="text-2xl font-bold mb-1">üéØ Planification 2026</h2><p class="text-indigo-200 text-sm">Bas√© sur une ann√©e type de 218 jours ouvr√©s.</p></div>
                        <div class="mt-4 md:mt-0 text-right bg-white/10 p-3 rounded-lg border border-white/20">
                            <p class="text-[10px] font-bold uppercase tracking-wider text-indigo-200">Capacit√© Projet Totale</p>
                            <p class="text-3xl font-extrabold text-white" id="totalYearlyCapacity">- JH</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-4" id="projectionContainer"></div>
                </div>

            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal()"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg overflow-y-auto z-50">
            <div class="modal-content py-4 text-left px-6">
                <p class="text-2xl font-bold text-indigo-900 border-b pb-2 mb-4">Param√®tres</p>
                <div class="flex gap-2 mb-6">
                    <button onclick="exportConfig()" class="flex-1 bg-indigo-600 text-white font-bold py-2 rounded text-xs">Exporter Config</button>
                    <label class="flex-1 bg-white border border-indigo-300 text-indigo-700 font-bold py-2 rounded text-xs cursor-pointer text-center">Importer...<input type="file" id="configInput" accept=".json" class="hidden" onchange="importConfig(this)"></label>
                </div>
                <h4 class="font-bold text-gray-700 mb-2 text-sm uppercase">Grandes Cat√©gories</h4>
                <div class="flex gap-2 mb-4"><input type="text" id="newCatInput" placeholder="Nouvelle..." class="border p-2 rounded w-full text-sm"><button onclick="addCategory()" class="bg-indigo-600 text-white font-bold px-4 rounded text-sm">+</button></div>
                <ul id="categoriesList" class="bg-gray-50 rounded border max-h-60 overflow-y-auto p-2 space-y-2"></ul>
                <div class="mt-6 pt-4 border-t flex justify-between">
                    <button onclick="resetToDefaults()" class="text-xs text-red-500 underline">R√©tablir d√©fauts</button>
                    <button onclick="toggleModal()" class="px-4 py-2 bg-gray-200 rounded text-xs">Fermer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);

        // --- GESTION DU MENU ET PERSISTANCE (sessionStorage) ---
        document.addEventListener("DOMContentLoaded", function() {
            // Charger le menu
            fetch('menu.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('menu-placeholder').innerHTML = html;
                    setActiveLink();
                })
                .catch(err => console.error("Erreur menu:", err));

            // V√©rifier si des donn√©es existent d√©j√†
            const savedData = sessionStorage.getItem('dragonfly_raw_data');
            if (savedData) {
                rawData = JSON.parse(savedData);
                initUI();
            }
        });

        function setActiveLink() {
            const currentFullUrl = window.location.href;
            const links = document.querySelectorAll('.nav-links a');
            links.forEach(l => {
                const linkUrl = l.getAttribute('href');
                // Gestion sp√©cifique GitHub Pages
                if (currentFullUrl.includes(linkUrl) || (linkUrl.includes('index.html') && currentFullUrl === "https://meresis.github.io/Wrike-dashboad---Manitou-Group/")) {
                    l.classList.add('active');
                }
            });
        }

        // --- LOGIQUE DRAGONFLY ---
        const STORAGE_VERSION = 'v2.6';
        const LS_CATS_KEY = `df_cats_${STORAGE_VERSION}`; 
        const LS_MAP_KEY = `df_mapping_${STORAGE_VERSION}`;
        const DEFAULTS = ["MCO", "SUPPORT", "GESTION OPERATIONNELLE", "PROJETS", "MANAGEMENT", "FORMATION / TRANSFERT", "CONGES / ABSENCES", "REUNIONS"];
        const STANDARD_DAY_HOURS = 8.0;

        let MACRO_CATS = JSON.parse(localStorage.getItem(LS_CATS_KEY)) || [...DEFAULTS];
        let categoryMapping = JSON.parse(localStorage.getItem(LS_MAP_KEY)) || {};
        let rawData = [], currentStats = {}, detectedDays = 1;
        let trendChartInstance, distributionChartInstance;
        const COLORS = ['#4f46e5', '#ec4899', '#10b981', '#f59e0b', '#3b82f6', '#8b5cf6', '#ef4444', '#14b8a6'];

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // Sauvegarder pour la navigation
                sessionStorage.setItem('dragonfly_raw_data', JSON.stringify(rawData));
                initUI();
            }; reader.readAsArrayBuffer(file);
        });

        function initUI() {
            document.getElementById('uploadZone').classList.add('hidden');
            document.getElementById('statusBadge').classList.remove('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            const users = [...new Set(rawData.map(r => r['Nom']).filter(n => n))].sort();
            const select = document.getElementById('userSelect');
            select.innerHTML = users.map(u => `<option value="${u}">${u}</option>`).join('');
            select.addEventListener('change', updateAnalysis);
            document.getElementById('yearSelect').addEventListener('change', updateAnalysis);
            updateAnalysis();
        }

        function updateAnalysis() {
            const user = document.getElementById('userSelect').value, year = document.getElementById('yearSelect').value;
            if(!user) return;
            const filtered = rawData.filter(row => {
                const d = row['Date']; let y = (typeof d === 'number') ? XLSX.SSF.parse_date_code(d).y : String(d).substring(0,4);
                return row['Nom'] === user && y == year;
            });
            const uniqueDays = new Set(); currentStats = {};
            filtered.forEach(row => {
                if(row['Date']) uniqueDays.add(row['Date']);
                const act = row['Activit√©'] || "Non cat√©goris√©";
                let h = parseFloat(String(row['temps en heure']).replace(',', '.')) || 0;
                currentStats[act] = (currentStats[act] || 0) + h;
            });
            detectedDays = Math.max(1, uniqueDays.size);
            document.getElementById('detectedDaysCount').innerText = uniqueDays.size;
            renderDetailTable(); renderMacroTable(); renderDistributionChart();
        }

        function renderDetailTable() {
            const user = document.getElementById('userSelect').value;
            const tbody = document.getElementById('statsTableBody'); tbody.innerHTML = '';
            const acts = Object.keys(currentStats).sort((a,b) => currentStats[b] - currentStats[a]);
            acts.forEach(act => {
                const total = currentStats[act], savedCat = categoryMapping[user]?.[act] || "";
                let options = `<option value="">-- Choisir --</option>` + MACRO_CATS.map(c => `<option value="${c}" ${c===savedCat?'selected':''}>${c}</option>`).join('');
                tbody.innerHTML += `<tr><td class="font-bold text-slate-700 text-xs">${act}</td><td class="bg-indigo-50"><select onchange="saveMapping('${user.replace(/'/g,"\\'")}', '${act.replace(/'/g,"\\'")}', this.value)" class="w-full text-[10px] p-1 rounded border">${options}</select></td><td class="text-right text-xs font-medium">${total.toFixed(1)}</td><td class="text-right font-bold text-amber-700 bg-amber-50 text-xs">${(total/detectedDays).toFixed(2)}</td></tr>`;
            });
        }

        function saveMapping(user, act, cat) {
            if(!categoryMapping[user]) categoryMapping[user] = {};
            categoryMapping[user][act] = cat;
            localStorage.setItem(LS_MAP_KEY, JSON.stringify(categoryMapping));
            renderMacroTable(); renderDistributionChart();
        }

        function renderDistributionChart() {
            const user = document.getElementById('userSelect').value; if(!user) return;
            const totals = {}; MACRO_CATS.forEach(c => totals[c] = 0); let unassigned = 0;
            Object.entries(currentStats).forEach(([act, h]) => {
                const cat = categoryMapping[user]?.[act];
                if(cat && MACRO_CATS.includes(cat)) totals[cat] += h; else unassigned += h;
            });
            let dataArr = MACRO_CATS.map(l => ({ label: l, value: totals[l] }));
            if(unassigned > 0) dataArr.push({label: "Non affect√©", value: unassigned});
            dataArr.sort((a, b) => b.value - a.value);
            const ctx = document.getElementById('distributionChart').getContext('2d');
            if(distributionChartInstance) distributionChartInstance.destroy();
            distributionChartInstance = new Chart(ctx, {
                type: 'bar', data: { labels: dataArr.map(d=>d.label), datasets: [{ data: dataArr.map(d=>d.value), backgroundColor: COLORS, borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'end', formatter: v => Math.round(v)+'h', font: { size: 10 } } }, scales: { y: { beginAtZero: true }, x: { ticks: { font: { size: 9 }, maxRotation: 45, minRotation: 45 } } } }
            });
        }

        function renderMacroTable() {
            const user = document.getElementById('userSelect').value, year = document.getElementById('yearSelect').value;
            const tbody = document.getElementById('macroTableBody'); tbody.innerHTML = '';
            const macro = {}; MACRO_CATS.forEach(c => macro[c] = 0);
            const season = {}; for(let i=1; i<=12; i++) season[String(i).padStart(2,'0')] = { total: 0, projet: 0, mco: 0, support: 0, gestion: 0, autre: 0 };
            const filtered = rawData.filter(row => {
                const d = row['Date']; let y = (typeof d === 'number') ? XLSX.SSF.parse_date_code(d).y : String(d).substring(0,4);
                return row['Nom'] === user && y == year;
            });
            filtered.forEach(row => {
                const h = parseFloat(String(row['temps en heure']).replace(',', '.')) || 0;
                const cat = categoryMapping[user]?.[row['Activit√©']];
                if(cat && MACRO_CATS.includes(cat)) macro[cat] += h;
                let m = (typeof row['Date'] === 'number') ? String(XLSX.SSF.parse_date_code(row['Date']).m).padStart(2,'0') : row['Date'].split('-')[1];
                if(season[m]) {
                    season[m].total += h;
                    if(cat === "PROJETS") season[m].projet += h;
                    else if(cat === "MCO") season[m].mco += h;
                    else if(cat === "SUPPORT") season[m].support += h;
                    else if(cat?.includes("GESTION")) season[m].gestion += h;
                    else season[m].autre += h;
                }
            });
            let nonProj = Object.keys(macro).reduce((acc, c) => c!=="PROJETS" ? acc+macro[c] : acc, 0);
            let runAvg = nonProj / detectedDays, cap = Math.max(0, 8 - runAvg);
            document.getElementById('kpiRunLoad').innerText = runAvg.toFixed(2) + ' h';
            document.getElementById('kpiProjectCapacity').innerText = cap.toFixed(2) + ' h';
            document.getElementById('reservoirLiquid').style.height = (runAvg/8*100) + '%';
            MACRO_CATS.forEach(c => {
                tbody.innerHTML += `<tr class="border-b"><td class="py-2 px-4 text-xs font-bold">${c}</td><td class="text-right text-xs">${macro[c].toFixed(1)}h</td><td class="text-right text-xs font-bold bg-indigo-50">${(macro[c]/detectedDays).toFixed(2)}h</td></tr>`;
            });
            renderTrendChart(season); generateProjections(season);
        }

        function renderTrendChart(s) {
            const ctx = document.getElementById('trendChart').getContext('2d'); if(trendChartInstance) trendChartInstance.destroy();
            const keys = Object.keys(s);
            trendChartInstance = new Chart(ctx, {
                type: 'line', data: { labels: ["Jan","F√©v","Mar","Avr","Mai","Juin","Juil","Ao√ªt","Sep","Oct","Nov","D√©c"], datasets: [{ label: 'Charge Run', data: keys.map(k=>s[k].mco+s[k].support+s[k].gestion+s[k].autre), borderColor: '#ef4444', fill: false, tension: 0.3 }, { label: 'Capacit√© Projet', data: keys.map(k=>s[k].projet), borderColor: '#10b981', fill: false, tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { display: false } } }
            });
        }

        function generateProjections(s) {
            const container = document.getElementById('projectionContainer'); container.innerHTML = '';
            const months = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
            let yearlyJH = 0;
            Object.keys(s).forEach((k, i) => {
                const d = s[k]; if(d.total < 1) return;
                const hRun = ((d.mco+d.support+d.gestion+d.autre)/d.total)*8, hProj = Math.max(0, 8-hRun), jh = (hProj*21)/8; yearlyJH += jh;
                container.innerHTML += `<div class="bg-white rounded-lg shadow border-l-4 border-indigo-500 p-4 flex flex-col md:flex-row items-center gap-4">
                    <div class="w-32 font-bold text-slate-700 uppercase text-sm">${months[i]}</div>
                    <div class="flex-1 grid grid-cols-4 gap-2 text-[10px] text-center">
                        <div class="bg-blue-50 p-1 rounded">MCO: ${((d.mco/d.total)*8).toFixed(1)}h</div>
                        <div class="bg-orange-50 p-1 rounded">SUP: ${((d.support/d.total)*8).toFixed(1)}h</div>
                        <div class="bg-purple-50 p-1 rounded">GES: ${((d.gestion/d.total)*8).toFixed(1)}h</div>
                        <div class="bg-gray-50 p-1 rounded">AUT: ${((d.autre/d.total)*8).toFixed(1)}h</div>
                    </div>
                    <div class="w-32 text-center bg-green-50 p-2 rounded border border-green-100">
                        <p class="text-xs font-bold text-green-700">${hProj.toFixed(1)} h/j</p>
                        <p class="text-[9px] text-green-600 font-bold uppercase">${jh.toFixed(1)} JH</p>
                    </div>
                </div>`;
            });
            document.getElementById('totalYearlyCapacity').innerText = yearlyJH.toFixed(1) + " JH";
        }

        function switchTab(id) {
            ['tab1', 'tab2', 'tab3'].forEach(t => document.getElementById(t).classList.add('hidden'));
            ['btn-tab1', 'btn-tab2', 'btn-tab3'].forEach(b => document.getElementById(b).className = "tab-inactive flex-1 py-3 rounded-md text-xs transition-all");
            document.getElementById(id).classList.remove('hidden');
            document.getElementById('btn-'+id).className = "tab-active flex-1 py-3 rounded-md text-xs transition-all";
        }

        function toggleModal() { document.getElementById('settingsModal').classList.toggle('opacity-0'); document.getElementById('settingsModal').classList.toggle('pointer-events-none'); renderSettingsList(); }
        function renderSettingsList() { document.getElementById('categoriesList').innerHTML = MACRO_CATS.map((c,i) => `<li class="flex justify-between items-center bg-white p-2 rounded border text-xs font-medium">${c}<button onclick="deleteCategory(${i})" class="text-red-500 font-bold px-2">√ó</button></li>`).join(''); }
        function addCategory() { const v = document.getElementById('newCatInput').value.trim().toUpperCase(); if(v) { MACRO_CATS.push(v); localStorage.setItem(LS_CATS_KEY, JSON.stringify(MACRO_CATS)); renderSettingsList(); } }
        function deleteCategory(i) { MACRO_CATS.splice(i,1); localStorage.setItem(LS_CATS_KEY, JSON.stringify(MACRO_CATS)); renderSettingsList(); }
        function resetToDefaults() { MACRO_CATS = [...DEFAULTS]; localStorage.setItem(LS_CATS_KEY, JSON.stringify(MACRO_CATS)); renderSettingsList(); }
        function exportConfig() { const blob = new Blob([JSON.stringify({cats: MACRO_CATS, map: categoryMapping})], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'dragonfly_config.json'; a.click(); }
        function importConfig(input) { const reader = new FileReader(); reader.onload = e => { const res = JSON.parse(e.target.result); MACRO_CATS = res.cats; categoryMapping = res.map; updateAnalysis(); }; reader.readAsText(input.files[0]); }
    </script>
</body>
</html>
